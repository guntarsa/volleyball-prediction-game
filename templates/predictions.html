{% extends "base.html" %}

{% block title %}Predictions - Volleyball Predictions{% endblock %}

{% block content %}
<h1 class="page-title">Make Your Predictions</h1>

{% if not games %}
<div class="alert alert-info text-center">
    <h4><i class="fas fa-calendar-times"></i> No Upcoming Games</h4>
    <p>There are no games available for predictions at the moment.</p>
    {% if current_user.is_admin %}
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Admin Panel</a>
    {% endif %}
</div>
{% else %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt"></i>
                    Upcoming Matches
                </h5>
            </div>
        </div>
    </div>
</div>

<!-- Group games by date -->
{% set games_by_date = {} %}
{% for game in games %}
    {% set game_date = game.game_date.strftime('%Y-%m-%d') %}
    {% if game_date not in games_by_date %}
        {% set _ = games_by_date.update({game_date: []}) %}
    {% endif %}
    {% set _ = games_by_date[game_date].append(game) %}
{% endfor %}

<!-- Date navigation -->
{% if games_by_date %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar"></i> Filter Games by Date
                </h5>
            </div>
            <div class="card-body">
                <!-- Mobile/Desktop Filter Controls -->
                <div class="d-none d-md-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAllDates()" id="showAllBtn">
                        <i class="fas fa-eye"></i> Show All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="hideAllDates()" id="hideAllBtn">
                        <i class="fas fa-eye-slash"></i> Hide All
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="showUpcomingOnly()" id="upcomingBtn">
                        <i class="fas fa-clock"></i> Upcoming Only
                    </button>
                </div>
                
                <!-- Mobile-Only Filter Controls -->
                <div class="d-md-none mb-3">
                    <div class="row g-2">
                        <div class="col-4">
                            <button class="btn btn-sm btn-outline-primary w-100" onclick="showAllDates()" id="showAllBtnMobile">
                                <i class="fas fa-eye d-block mb-1"></i>
                                <small>Show All</small>
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="hideAllDates()" id="hideAllBtnMobile">
                                <i class="fas fa-eye-slash d-block mb-1"></i>
                                <small>Hide All</small>
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-sm btn-outline-success w-100" onclick="showUpcomingOnly()" id="upcomingBtnMobile">
                                <i class="fas fa-clock d-block mb-1"></i>
                                <small>Upcoming</small>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Date Selection - Horizontal Scroll on Mobile -->
                <div class="date-buttons-container">
                    <div class="d-none d-md-block">
                        <small class="text-muted mb-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Click dates to show/hide specific days
                        </small>
                    </div>
                    <div class="d-md-none mb-2">
                        <small class="text-muted">
                            <i class="fas fa-swatchbook me-1"></i>
                            Swipe left/right to see more dates
                        </small>
                    </div>
                    <div class="date-scroll-container">
                        {% for date_str in games_by_date.keys() | sort %}
                            {% set date_obj = games_by_date[date_str][0].game_date %}
                            {% set has_upcoming = games_by_date[date_str] | selectattr('is_finished', 'equalto', False) | list | length > 0 %}
                            <button class="btn btn-sm date-filter-btn me-2 mb-2 
                                           {% if has_upcoming %}btn-success{% else %}btn-secondary{% endif %}"
                                    onclick="toggleDate('{{ date_str }}')" 
                                    id="dateBtn_{{ date_str }}"
                                    data-has-upcoming="{{ has_upcoming }}">
                                <i class="fas fa-calendar-day mb-1 d-block d-md-inline"></i>
                                <div class="d-md-none">
                                    <div class="fw-bold">{{ date_obj.strftime('%m/%d') }}</div>
                                    <small>{{ games_by_date[date_str] | length }}g</small>
                                </div>
                                <span class="d-none d-md-inline">
                                    {{ date_obj.strftime('%b %d') }}
                                    <small class="d-block">{{ games_by_date[date_str] | length }} games</small>
                                </span>
                            </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Games organized by date -->
{% for date_str in games_by_date.keys() | sort %}
    {% set date_games = games_by_date[date_str] %}
    {% set date_obj = date_games[0].game_date %}
    {% set upcoming_count = date_games | selectattr('is_finished', 'equalto', False) | list | length %}
    {% set finished_count = date_games | selectattr('is_finished', 'equalto', True) | list | length %}
    
    <div class="date-section mb-4" id="dateSection_{{ date_str }}" style="display: block;">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white cursor-pointer" onclick="toggleDateSection('{{ date_str }}')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i>
                        {{ date_obj.strftime('%A, %B %d, %Y') }}
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">
                            {% if upcoming_count > 0 %}
                                {{ upcoming_count }} upcoming
                            {% endif %}
                            {% if finished_count > 0 %}
                                {% if upcoming_count > 0 %}, {% endif %}
                                {{ finished_count }} finished
                            {% endif %}
                        </span>
                        <i class="fas fa-chevron-down toggle-icon" id="toggleIcon_{{ date_str }}"></i>
                    </div>
                </div>
            </div>
            <div class="collapse show" id="dateContent_{{ date_str }}">
                <div class="card-body p-0">
                    {% for game in date_games %}
                    <div class="game-card border-bottom {% if not loop.last %}mb-3{% endif %}" id="game_{{ game.id }}">
                        {% if game.is_finished %}
                        <!-- Finished Game Display -->
                        <div class="p-3 bg-light rounded mb-3">
                            <div class="row text-center">
                                <div class="col-12 mb-2">
                                    <h6 class="text-muted">{{ game.round_name }} - {{ game.game_date.strftime('%H:%M') }}</h6>
                                </div>
                                <div class="col-5">
                                    <h5 class="team-name">
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team1 }}
                                        {% if game.team1_score > game.team2_score %}
                                            <span class="badge bg-success ms-1">W</span>
                                        {% endif %}
                                    </h5>
                                    <h3 class="text-primary fw-bold">{{ game.team1_score }}</h3>
                                </div>
                                <div class="col-2 d-flex align-items-center justify-content-center">
                                    <span class="h4 text-muted">-</span>
                                </div>
                                <div class="col-5">
                                    <h5 class="team-name">
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team2 }}
                                        {% if game.team2_score > game.team1_score %}
                                            <span class="badge bg-success ms-1">W</span>
                                        {% endif %}
                                    </h5>
                                    <h3 class="text-primary fw-bold">{{ game.team2_score }}</h3>
                                </div>
                                {% if game.are_predictions_visible() %}
                                <div class="col-12 mt-3">
                                    <button class="btn btn-outline-info btn-sm" onclick="loadAllPredictions({{ game.id }})">
                                        <i class="fas fa-eye"></i> View Predictions
                                    </button>
                                    <div id="predictions_{{ game.id }}" class="mt-3" style="display: none;"></div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Active Game Display -->
                        <div class="p-3">
                            <div class="mb-2 text-center">
                                <h6 class="text-primary">{{ game.round_name }} - {{ game.game_date.strftime('%H:%M') }}</h6>
                                {% if game.is_prediction_open() %}
                                    <small class="text-success">
                                        <i class="fas fa-unlock"></i> Deadline: {{ game.prediction_deadline.strftime('%H:%M') }}
                                    </small>
                                {% else %}
                                    <small class="text-danger">
                                        <i class="fas fa-lock"></i> Predictions Locked
                                    </small>
                                {% endif %}
                            </div>
                            {% if game.is_prediction_open() %}
        <form method="POST" action="{{ url_for('make_prediction') }}" class="prediction-form">
            <input type="hidden" name="game_id" value="{{ game.id }}">
            
            <!-- Desktop Layout -->
            <div class="row d-none d-md-flex">
                <!-- Team 1 Column -->
                <div class="col-md-5">
                    <div class="team-prediction-card text-center">
                        <div class="mb-3">
                            <h5 class="team-name fw-bold text-primary mb-2">
                                {% if get_country_code(game.team1) %}
                                    <span class="fi fi-{{ get_country_code(game.team1) }} team-flag-large"></span>
                                {% endif %}
                                {{ game.team1 }}
                            </h5>
                        </div>
                        <div class="prediction-input-section">
                            <input type="number" name="team1_score" id="team1_score_{{ game.id }}" 
                                   class="form-control form-control-lg text-center score-input" 
                                   min="0" max="3" placeholder="0-3">
                        </div>
                    </div>
                </div>
                
                <!-- VS and Submit Column -->
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="vs-section mb-4">
                            <span class="vs-text h3 text-muted fw-bold">VS</span>
                        </div>
                        <div class="submit-section">
                            <button type="submit" class="btn btn-success w-100" id="submit_btn_{{ game.id }}">
                                <i class="fas fa-save"></i>
                                <span id="submit_text_{{ game.id }}">Save Prediction</span>
                            </button>
                            <div class="prediction-status mt-2" id="status_{{ game.id }}" style="display: none;">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="status_text_{{ game.id }}">Prediction saved</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Team 2 Column -->
                <div class="col-md-5">
                    <div class="team-prediction-card text-center">
                        <div class="mb-3">
                            <h5 class="team-name fw-bold text-primary mb-2">
                                {% if get_country_code(game.team2) %}
                                    <span class="fi fi-{{ get_country_code(game.team2) }} team-flag-large"></span>
                                {% endif %}
                                {{ game.team2 }}
                            </h5>
                        </div>
                        <div class="prediction-input-section">
                            <input type="number" name="team2_score" id="team2_score_{{ game.id }}" 
                                   class="form-control form-control-lg text-center score-input" 
                                   min="0" max="3" placeholder="0-3">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Layout -->
            <div class="mobile-prediction-stack d-md-none">
                <!-- Team 1 Mobile Card -->
                <div class="mobile-team-card bg-light">
                    <div class="text-center mb-3">
                        <h5 class="team-name fw-bold text-primary mb-2">
                            {% if get_country_code(game.team1) %}
                                <span class="fi fi-{{ get_country_code(game.team1) }} team-flag-large"></span>
                            {% endif %}
                            {{ game.team1 }}
                        </h5>
                    </div>
                    <div class="prediction-input-section text-center">
                        <input type="number" name="team1_score" id="team1_score_mobile_{{ game.id }}" 
                               class="form-control form-control-lg text-center score-input mx-auto d-block" 
                               min="0" max="3" placeholder="0-3">
                    </div>
                </div>
                
                <!-- Mobile VS Section -->
                <div class="mobile-vs-section">
                    <span class="h2 text-muted fw-bold">VS</span>
                </div>
                
                <!-- Team 2 Mobile Card -->
                <div class="mobile-team-card bg-light">
                    <div class="text-center mb-3">
                        <h5 class="team-name fw-bold text-primary mb-2">
                            {% if get_country_code(game.team2) %}
                                <span class="fi fi-{{ get_country_code(game.team2) }} team-flag-large"></span>
                            {% endif %}
                            {{ game.team2 }}
                        </h5>
                    </div>
                    <div class="prediction-input-section text-center">
                        <input type="number" name="team2_score" id="team2_score_mobile_{{ game.id }}" 
                               class="form-control form-control-lg text-center score-input mx-auto d-block" 
                               min="0" max="3" placeholder="0-3">
                    </div>
                </div>
                
                <!-- Mobile Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-success mobile-submit-btn" id="submit_btn_mobile_{{ game.id }}">
                        <i class="fas fa-save me-2"></i>
                        <span id="submit_text_mobile_{{ game.id }}">Save Prediction</span>
                    </button>
                    <div class="prediction-status mt-3" id="status_mobile_{{ game.id }}" style="display: none;">
                        <div class="alert alert-success py-2 mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="status_text_mobile_{{ game.id }}">Prediction saved</span>
                        </div>
                    </div>
                </div>
            </div>
            
        </form>
        {% else %}
        <div class="alert alert-warning text-center">
            <i class="fas fa-lock"></i>
            Prediction deadline has passed for this game
        </div>
        
        {% if game.are_predictions_visible() %}
        <div class="mt-3">
            <button class="btn btn-info w-100" onclick="loadAllPredictions({{ game.id }})">
                <i class="fas fa-eye"></i> Show All Predictions
            </button>
            <div id="predictions_{{ game.id }}" class="mt-3" style="display: none;"></div>
        </div>
        {% endif %}
                        {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endfor %}

{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Load user's existing prediction when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.prediction-form').forEach(form => {
        const gameId = form.querySelector('input[name="game_id"]').value;
        loadUserPrediction(gameId);
        
        // Add volleyball scoring validation
        addVolleyballValidation(form);
    });
    
    // Handle URL anchor to scroll to specific game
    handleGameAnchor();
});

function loadUserPrediction(gameId) {
    fetch(`/get_prediction/${gameId}`)
        .then(response => response.json())
        .then(data => {
            // Get both desktop and mobile elements
            const team1Input = document.getElementById(`team1_score_${gameId}`);
            const team2Input = document.getElementById(`team2_score_${gameId}`);
            const team1InputMobile = document.getElementById(`team1_score_mobile_${gameId}`);
            const team2InputMobile = document.getElementById(`team2_score_mobile_${gameId}`);
            
            const submitText = document.getElementById(`submit_text_${gameId}`);
            const submitBtn = document.getElementById(`submit_btn_${gameId}`);
            const submitTextMobile = document.getElementById(`submit_text_mobile_${gameId}`);
            const submitBtnMobile = document.getElementById(`submit_btn_mobile_${gameId}`);
            
            const statusDiv = document.getElementById(`status_${gameId}`);
            const statusText = document.getElementById(`status_text_${gameId}`);
            const statusDivMobile = document.getElementById(`status_mobile_${gameId}`);
            const statusTextMobile = document.getElementById(`status_text_mobile_${gameId}`);
            
            if (data.team1_score !== null && data.team2_score !== null && data.team1_score !== '' && data.team2_score !== '') {
                // Existing prediction found - update both desktop and mobile
                if (team1Input) team1Input.value = data.team1_score;
                if (team2Input) team2Input.value = data.team2_score;
                if (team1InputMobile) team1InputMobile.value = data.team1_score;
                if (team2InputMobile) team2InputMobile.value = data.team2_score;
                
                // Update desktop button and status
                if (submitText) submitText.textContent = 'Update Prediction';
                if (submitBtn) {
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-warning');
                    const icon = submitBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-save');
                        icon.classList.add('fa-edit');
                    }
                }
                
                // Update mobile button and status
                if (submitTextMobile) submitTextMobile.textContent = 'Update Prediction';
                if (submitBtnMobile) {
                    submitBtnMobile.classList.remove('btn-success');
                    submitBtnMobile.classList.add('btn-warning');
                    const iconMobile = submitBtnMobile.querySelector('i');
                    if (iconMobile) {
                        iconMobile.classList.remove('fa-save');
                        iconMobile.classList.add('fa-edit');
                    }
                }
                
                // Show status on both layouts
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    if (statusText) statusText.textContent = `Current: ${data.team1_score} - ${data.team2_score}`;
                }
                if (statusDivMobile) {
                    statusDivMobile.style.display = 'block';
                    if (statusTextMobile) statusTextMobile.textContent = `Current: ${data.team1_score} - ${data.team2_score}`;
                }
                
                // Add visual enhancement to form inputs
                if (team1Input) team1Input.classList.add('has-prediction');
                if (team2Input) team2Input.classList.add('has-prediction');
                if (team1InputMobile) team1InputMobile.classList.add('has-prediction');
                if (team2InputMobile) team2InputMobile.classList.add('has-prediction');
                
                // Add visual enhancement to team cards
                const team1Card = team1Input?.closest('.team-prediction-card');
                const team2Card = team2Input?.closest('.team-prediction-card');
                const team1CardMobile = team1InputMobile?.closest('.mobile-team-card');
                const team2CardMobile = team2InputMobile?.closest('.mobile-team-card');
                
                if (team1Card) team1Card.classList.add('has-existing-prediction');
                if (team2Card) team2Card.classList.add('has-existing-prediction');
                if (team1CardMobile) team1CardMobile.classList.add('has-existing-prediction');
                if (team2CardMobile) team2CardMobile.classList.add('has-existing-prediction');
            } else {
                // No prediction exists - reset both layouts
                if (team1Input) team1Input.value = '';
                if (team2Input) team2Input.value = '';
                if (team1InputMobile) team1InputMobile.value = '';
                if (team2InputMobile) team2InputMobile.value = '';
                
                // Reset desktop button
                if (submitText) submitText.textContent = 'Save Prediction';
                if (submitBtn) {
                    submitBtn.classList.remove('btn-warning');
                    submitBtn.classList.add('btn-success');
                    const icon = submitBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-edit');
                        icon.classList.add('fa-save');
                    }
                }
                
                // Reset mobile button
                if (submitTextMobile) submitTextMobile.textContent = 'Save Prediction';
                if (submitBtnMobile) {
                    submitBtnMobile.classList.remove('btn-warning');
                    submitBtnMobile.classList.add('btn-success');
                    const iconMobile = submitBtnMobile.querySelector('i');
                    if (iconMobile) {
                        iconMobile.classList.remove('fa-edit');
                        iconMobile.classList.add('fa-save');
                    }
                }
                
                // Hide status on both layouts
                if (statusDiv) statusDiv.style.display = 'none';
                if (statusDivMobile) statusDivMobile.style.display = 'none';
                
                // Remove visual enhancement
                if (team1Input) team1Input.classList.remove('has-prediction');
                if (team2Input) team2Input.classList.remove('has-prediction');
                if (team1InputMobile) team1InputMobile.classList.remove('has-prediction');
                if (team2InputMobile) team2InputMobile.classList.remove('has-prediction');
                
                // Remove visual enhancement from team cards
                const team1Card = team1Input?.closest('.team-prediction-card');
                const team2Card = team2Input?.closest('.team-prediction-card');
                const team1CardMobile = team1InputMobile?.closest('.mobile-team-card');
                const team2CardMobile = team2InputMobile?.closest('.mobile-team-card');
                
                if (team1Card) team1Card.classList.remove('has-existing-prediction');
                if (team2Card) team2Card.classList.remove('has-existing-prediction');
                if (team1CardMobile) team1CardMobile.classList.remove('has-existing-prediction');
                if (team2CardMobile) team2CardMobile.classList.remove('has-existing-prediction');
            }
        })
        .catch(error => console.error('Error loading prediction:', error));
}

function loadAllPredictions(gameId) {
    const container = document.getElementById(`predictions_${gameId}`);
    
    fetch(`/game_predictions/${gameId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>Player</th><th>Prediction</th><th>Points</th></tr></thead><tbody>';
            
            data.predictions.forEach(pred => {
                const points = pred.points !== null ? pred.points : '-';
                html += `<tr>
                    <td><strong>${pred.user_name}</strong></td>
                    <td>${pred.team1_score} - ${pred.team2_score}</td>
                    <td><span class="badge bg-primary">${points}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            container.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading predictions:', error);
            container.innerHTML = '<div class="alert alert-danger">Error loading predictions</div>';
        });
}

// Countdown timer for deadlines
function updateCountdowns() {
    document.querySelectorAll('.deadline-countdown').forEach(element => {
        const deadline = new Date(element.dataset.deadline);
        const now = new Date();
        const diff = deadline - now;
        
        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            element.textContent = `${hours}h ${minutes}m remaining`;
            element.className = 'text-warning';
        } else {
            element.textContent = 'Deadline passed';
            element.className = 'text-danger';
        }
    });
}

// Update countdowns every minute
setInterval(updateCountdowns, 60000);
updateCountdowns();

function addVolleyballValidation(form) {
    // Only validate on form submission - no real-time validation to avoid UX issues
    form.addEventListener('submit', function(e) {
        // Determine which layout is currently visible
        const isMobile = window.innerWidth < 768;
        
        // Use AJAX for mobile to avoid page reload and keep focus
        if (isMobile) {
            e.preventDefault();
            handleMobilePredictionSubmit(form);
            return;
        }
        
        // Get the appropriate inputs based on viewport
        let team1Input, team2Input;
        
        if (isMobile) {
            // Use mobile inputs - get the specific mobile inputs for this form
            const gameId = form.querySelector('input[name="game_id"]').value;
            team1Input = form.querySelector(`#team1_score_mobile_${gameId}`);
            team2Input = form.querySelector(`#team2_score_mobile_${gameId}`);
        } else {
            // Use desktop inputs
            team1Input = form.querySelector('input[name="team1_score"]:not([id*="_mobile_"])');
            team2Input = form.querySelector('input[name="team2_score"]:not([id*="_mobile_"])');
        }
        
        // If we couldn't find the right inputs, fall back to any visible inputs
        if (!team1Input || !team2Input) {
            const allTeam1Inputs = form.querySelectorAll('input[name="team1_score"]');
            const allTeam2Inputs = form.querySelectorAll('input[name="team2_score"]');
            
            // Find the visible inputs
            for (let input of allTeam1Inputs) {
                const rect = input.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    team1Input = input;
                    break;
                }
            }
            
            for (let input of allTeam2Inputs) {
                const rect = input.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    team2Input = input;
                    break;
                }
            }
        }
        
        if (!team1Input || !team2Input) {
            console.error('Could not find form inputs');
            return;
        }
        
        const team1Value = team1Input.value.trim();
        const team2Value = team2Input.value.trim();
        
        // Clear any previous validation styling from all inputs
        const allInputs = form.querySelectorAll('input[name="team1_score"], input[name="team2_score"]');
        allInputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
        
        // Check if both fields are filled
        if (!team1Value || !team2Value) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Please fill in both score fields.');
            return;
        }
        
        const team1Score = parseInt(team1Value);
        const team2Score = parseInt(team2Value);
        
        // Check if values are valid numbers within range
        if (isNaN(team1Score) || isNaN(team2Score) || 
            team1Score < 0 || team1Score > 3 || 
            team2Score < 0 || team2Score > 3) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Please enter valid scores between 0 and 3.');
            return;
        }
        
        // Check if it's a valid volleyball score (one team has 3, other has 0-2)
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (!isValid) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Invalid volleyball score!\n\nValid scores:\n• 3-0 (sweep)\n• 3-1 (four sets)\n• 3-2 (five sets)\n\nWinner must have 3 sets, loser 0-2 sets.');
            return;
        }
        
        // Synchronize values between desktop and mobile inputs before submission
        const gameId = form.querySelector('input[name="game_id"]').value;
        const desktopTeam1 = form.querySelector(`#team1_score_${gameId}`);
        const desktopTeam2 = form.querySelector(`#team2_score_${gameId}`);
        const mobileTeam1 = form.querySelector(`#team1_score_mobile_${gameId}`);
        const mobileTeam2 = form.querySelector(`#team2_score_mobile_${gameId}`);
        
        // Sync values to ensure both forms have the same data
        if (desktopTeam1 && mobileTeam1) {
            desktopTeam1.value = team1Score;
            mobileTeam1.value = team1Score;
        }
        if (desktopTeam2 && mobileTeam2) {
            desktopTeam2.value = team2Score;
            mobileTeam2.value = team2Score;
        }
        
        // If we get here, the form is valid - add success styling
        team1Input.classList.add('is-valid');
        team2Input.classList.add('is-valid');
        
        // Add a small delay to show success state before submission
        setTimeout(() => {
            // The form will submit and page will redirect
            // When user comes back, loadUserPrediction will show the updated state
        }, 500);
    });
}

// Date filtering functions
function showAllDates() {
    const dateSections = document.querySelectorAll('.date-section');
    dateSections.forEach(section => {
        section.style.display = 'block';
        const dateStr = section.id.replace('dateSection_', '');
        const content = document.getElementById(`dateContent_${dateStr}`);
        if (content) {
            content.classList.add('show');
        }
        const icon = document.getElementById(`toggleIcon_${dateStr}`);
        if (icon) {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        }
    });
    
    // Update button states
    updateFilterButtonStates('showAll');
}

function hideAllDates() {
    const dateSections = document.querySelectorAll('.date-section');
    dateSections.forEach(section => {
        const dateStr = section.id.replace('dateSection_', '');
        const content = document.getElementById(`dateContent_${dateStr}`);
        if (content) {
            content.classList.remove('show');
        }
        const icon = document.getElementById(`toggleIcon_${dateStr}`);
        if (icon) {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    });
    
    // Update button states
    updateFilterButtonStates('hideAll');
}

function showUpcomingOnly() {
    const dateSections = document.querySelectorAll('.date-section');
    let hasUpcoming = false;
    
    dateSections.forEach(section => {
        const dateStr = section.id.replace('dateSection_', '');
        const upcomingGames = section.querySelectorAll('.game-card:not([data-finished="true"])');
        
        if (upcomingGames.length > 0) {
            section.style.display = 'block';
            const content = document.getElementById(`dateContent_${dateStr}`);
            if (content) {
                content.classList.add('show');
            }
            const icon = document.getElementById(`toggleIcon_${dateStr}`);
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
            hasUpcoming = true;
        } else {
            section.style.display = 'none';
        }
    });
    
    // Update button states
    updateFilterButtonStates('upcomingOnly');
}

function toggleDate(dateStr) {
    const section = document.getElementById(`dateSection_${dateStr}`);
    const button = document.getElementById(`dateBtn_${dateStr}`);
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
    } else {
        section.style.display = 'none';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }
}

function toggleDateSection(dateStr) {
    const content = document.getElementById(`dateContent_${dateStr}`);
    const icon = document.getElementById(`toggleIcon_${dateStr}`);
    
    if (content && icon) {
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        } else {
            content.classList.add('show');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        }
    }
}

function updateFilterButtonStates(activeFilter) {
    const showAllBtn = document.getElementById('showAllBtn');
    const hideAllBtn = document.getElementById('hideAllBtn');
    const upcomingBtn = document.getElementById('upcomingBtn');
    
    // Reset all buttons
    [showAllBtn, hideAllBtn, upcomingBtn].forEach(btn => {
        if (btn) {
            btn.classList.remove('btn-primary', 'btn-outline-primary', 'btn-outline-secondary', 'btn-outline-success');
        }
    });
    
    // Set active button
    switch (activeFilter) {
        case 'showAll':
            if (showAllBtn) {
                showAllBtn.classList.add('btn-primary');
                hideAllBtn.classList.add('btn-outline-secondary');
                upcomingBtn.classList.add('btn-outline-success');
            }
            break;
        case 'hideAll':
            if (hideAllBtn) {
                showAllBtn.classList.add('btn-outline-primary');
                hideAllBtn.classList.add('btn-secondary');
                upcomingBtn.classList.add('btn-outline-success');
            }
            break;
        case 'upcomingOnly':
            if (upcomingBtn) {
                showAllBtn.classList.add('btn-outline-primary');
                hideAllBtn.classList.add('btn-outline-secondary');
                upcomingBtn.classList.add('btn-success');
            }
            break;
        default:
            if (showAllBtn) {
                showAllBtn.classList.add('btn-outline-primary');
                hideAllBtn.classList.add('btn-outline-secondary');
                upcomingBtn.classList.add('btn-outline-success');
            }
    }
}

function handleMobilePredictionSubmit(form) {
    const gameId = form.querySelector('input[name="game_id"]').value;
    const team1Input = form.querySelector(`#team1_score_mobile_${gameId}`);
    const team2Input = form.querySelector(`#team2_score_mobile_${gameId}`);
    const submitBtn = form.querySelector(`#submit_btn_mobile_${gameId}`);
    const submitText = form.querySelector(`#submit_text_mobile_${gameId}`);
    const statusDiv = form.querySelector(`#status_mobile_${gameId}`);
    const statusText = form.querySelector(`#status_text_mobile_${gameId}`);
    
    if (!team1Input || !team2Input) {
        showMobileError('Form inputs not found');
        return;
    }
    
    const team1Value = team1Input.value.trim();
    const team2Value = team2Input.value.trim();
    
    // Validate inputs
    if (!team1Value || !team2Value) {
        showMobileError('Please fill in both score fields');
        team1Input.classList.add('is-invalid');
        team2Input.classList.add('is-invalid');
        return;
    }
    
    const team1Score = parseInt(team1Value);
    const team2Score = parseInt(team2Value);
    
    if (isNaN(team1Score) || isNaN(team2Score) || 
        team1Score < 0 || team1Score > 3 || 
        team2Score < 0 || team2Score > 3) {
        showMobileError('Please enter valid scores between 0 and 3');
        team1Input.classList.add('is-invalid');
        team2Input.classList.add('is-invalid');
        return;
    }
    
    // Check volleyball scoring
    const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                   (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
    
    if (!isValid) {
        showMobileError('Invalid volleyball score! Winner must have 3 sets, loser 0-2 sets.');
        team1Input.classList.add('is-invalid');
        team2Input.classList.add('is-invalid');
        return;
    }
    
    // Clear validation styling
    team1Input.classList.remove('is-invalid');
    team2Input.classList.remove('is-invalid');
    
    // Show loading state
    if (submitBtn) {
        submitBtn.disabled = true;
        const originalText = submitText ? submitText.textContent : 'Save';
        if (submitText) submitText.textContent = 'Saving...';
        
        // Make AJAX request
        fetch('/save_prediction_ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                game_id: gameId,
                team1_score: team1Score,
                team2_score: team2Score
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success feedback
                showMobileSuccess(data.message, statusDiv, statusText);
                
                // Update button appearance
                if (submitText) submitText.textContent = data.is_update ? 'Update Prediction' : 'Save Prediction';
                if (submitBtn) {
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-warning');
                    const icon = submitBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-save');
                        icon.classList.add('fa-edit');
                    }
                }
                
                // Add visual feedback to inputs
                team1Input.classList.add('is-valid');
                team2Input.classList.add('is-valid');
                setTimeout(() => {
                    team1Input.classList.remove('is-valid');
                    team2Input.classList.remove('is-valid');
                }, 3000);
                
            } else {
                showMobileError(data.error || 'Failed to save prediction');
            }
        })
        .catch(error => {
            console.error('Error saving prediction:', error);
            showMobileError('Network error. Please try again.');
        })
        .finally(() => {
            // Reset button state
            if (submitBtn) submitBtn.disabled = false;
            if (submitText && !submitText.textContent.includes('Update')) {
                submitText.textContent = originalText;
            }
        });
    }
}

function showMobileSuccess(message, statusDiv, statusText) {
    if (statusDiv && statusText) {
        statusText.textContent = message;
        statusDiv.style.display = 'block';
        statusDiv.querySelector('.alert').className = 'alert alert-success py-2 mb-0';
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 4000);
    }
}

function showMobileError(message) {
    // Create a temporary error toast
    const toast = document.createElement('div');
    toast.className = 'alert alert-danger position-fixed';
    toast.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 90%; animation: fadeInOut 4s ease-in-out forwards;';
    toast.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
    
    // Add CSS animation if not exists
    if (!document.querySelector('#mobile-toast-animation')) {
        const style = document.createElement('style');
        style.id = 'mobile-toast-animation';
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Remove after animation
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 4000);
}

function handleGameAnchor() {
    // Check if there's a hash in the URL (e.g., #game_123)
    const hash = window.location.hash;
    if (hash && hash.startsWith('#game_')) {
        const gameId = hash.replace('#game_', '');
        const gameElement = document.getElementById(`game_${gameId}`);
        
        if (gameElement) {
            // First, make sure the date section containing this game is visible
            const dateSection = gameElement.closest('.date-section');
            if (dateSection) {
                dateSection.style.display = 'block';
                
                // Expand the date content if it's collapsed
                const dateStr = dateSection.id.replace('dateSection_', '');
                const dateContent = document.getElementById(`dateContent_${dateStr}`);
                const toggleIcon = document.getElementById(`toggleIcon_${dateStr}`);
                
                if (dateContent && !dateContent.classList.contains('show')) {
                    dateContent.classList.add('show');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('fa-chevron-right');
                        toggleIcon.classList.add('fa-chevron-down');
                    }
                }
            }
            
            // Scroll to the game with a small delay to ensure DOM is ready
            setTimeout(() => {
                gameElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Add a subtle highlight effect
                gameElement.style.backgroundColor = '#fff3cd';
                gameElement.style.transition = 'background-color 0.5s ease';
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    gameElement.style.backgroundColor = '';
                }, 2000);
            }, 300);
        }
    }
}
</script>
{% endblock %}