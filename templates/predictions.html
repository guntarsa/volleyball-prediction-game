{% extends "base.html" %}

{% block title %}Predictions - Volleyball Predictions{% endblock %}

{% block content %}
<h1 class="page-title">Make Your Predictions</h1>

{% if not games %}
<div class="alert alert-info text-center">
    <h4><i class="fas fa-calendar-times"></i> No Upcoming Games</h4>
    <p>There are no games available for predictions at the moment.</p>
    {% if current_user.is_admin %}
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Admin Panel</a>
    {% endif %}
</div>
{% else %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt"></i>
                    Upcoming Matches
                </h5>
            </div>
        </div>
    </div>
</div>

<!-- Group games by date -->
{% set games_by_date = {} %}
{% for game in games %}
    {% set game_date = game.game_date.strftime('%Y-%m-%d') %}
    {% if game_date not in games_by_date %}
        {% set _ = games_by_date.update({game_date: []}) %}
    {% endif %}
    {% set _ = games_by_date[game_date].append(game) %}
{% endfor %}

<!-- Date navigation -->
{% if games_by_date %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar"></i> Filter Games by Date
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAllDates()" id="showAllBtn">
                        <i class="fas fa-eye"></i> Show All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="hideAllDates()" id="hideAllBtn">
                        <i class="fas fa-eye-slash"></i> Hide All
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="showUpcomingOnly()" id="upcomingBtn">
                        <i class="fas fa-clock"></i> Upcoming Only
                    </button>
                </div>
                <div class="date-buttons-container">
                    {% for date_str in games_by_date.keys() | sort %}
                        {% set date_obj = games_by_date[date_str][0].game_date %}
                        {% set is_today = date_obj.strftime('%Y-%m-%d') == moment().strftime('%Y-%m-%d') %}
                        {% set has_upcoming = games_by_date[date_str] | selectattr('is_finished', 'equalto', False) | list | length > 0 %}
                        <button class="btn btn-sm date-filter-btn me-2 mb-2 
                                       {% if has_upcoming %}btn-success{% else %}btn-secondary{% endif %}"
                                onclick="toggleDate('{{ date_str }}')" 
                                id="dateBtn_{{ date_str }}">
                            <i class="fas fa-calendar-day"></i>
                            {{ date_obj.strftime('%b %d') }}
                            {% if is_today %}<span class="badge bg-warning text-dark ms-1">Today</span>{% endif %}
                            <small class="d-block">{{ games_by_date[date_str] | length }} games</small>
                        </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Games organized by date -->
{% for date_str in games_by_date.keys() | sort %}
    {% set date_games = games_by_date[date_str] %}
    {% set date_obj = date_games[0].game_date %}
    {% set upcoming_count = date_games | selectattr('is_finished', 'equalto', False) | list | length %}
    {% set finished_count = date_games | selectattr('is_finished', 'equalto', True) | list | length %}
    
    <div class="date-section mb-4" id="dateSection_{{ date_str }}" style="display: block;">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white cursor-pointer" onclick="toggleDateSection('{{ date_str }}')">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i>
                        {{ date_obj.strftime('%A, %B %d, %Y') }}
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">
                            {% if upcoming_count > 0 %}
                                {{ upcoming_count }} upcoming
                            {% endif %}
                            {% if finished_count > 0 %}
                                {% if upcoming_count > 0 %}, {% endif %}
                                {{ finished_count }} finished
                            {% endif %}
                        </span>
                        <i class="fas fa-chevron-down toggle-icon" id="toggleIcon_{{ date_str }}"></i>
                    </div>
                </div>
            </div>
            <div class="collapse show" id="dateContent_{{ date_str }}">
                <div class="card-body p-0">
                    {% for game in date_games %}
                    <div class="game-card border-bottom {% if not loop.last %}mb-3{% endif %}">
                        {% if game.is_finished %}
                        <!-- Finished Game Display -->
                        <div class="p-3 bg-light rounded mb-3">
                            <div class="row text-center">
                                <div class="col-12 mb-2">
                                    <h6 class="text-muted">{{ game.round_name }} - {{ game.game_date.strftime('%H:%M') }}</h6>
                                </div>
                                <div class="col-5">
                                    <h5 class="team-name">
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team1 }}
                                        {% if game.team1_score > game.team2_score %}
                                            <span class="badge bg-success ms-1">W</span>
                                        {% endif %}
                                    </h5>
                                    <h3 class="text-primary fw-bold">{{ game.team1_score }}</h3>
                                </div>
                                <div class="col-2 d-flex align-items-center justify-content-center">
                                    <span class="h4 text-muted">-</span>
                                </div>
                                <div class="col-5">
                                    <h5 class="team-name">
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team2 }}
                                        {% if game.team2_score > game.team1_score %}
                                            <span class="badge bg-success ms-1">W</span>
                                        {% endif %}
                                    </h5>
                                    <h3 class="text-primary fw-bold">{{ game.team2_score }}</h3>
                                </div>
                                {% if game.are_predictions_visible() %}
                                <div class="col-12 mt-3">
                                    <button class="btn btn-outline-info btn-sm" onclick="loadAllPredictions({{ game.id }})">
                                        <i class="fas fa-eye"></i> View Predictions
                                    </button>
                                    <div id="predictions_{{ game.id }}" class="mt-3" style="display: none;"></div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Active Game Display -->
                        <div class="p-3">
                            <div class="mb-2 text-center">
                                <h6 class="text-primary">{{ game.round_name }} - {{ game.game_date.strftime('%H:%M') }}</h6>
                                {% if game.is_prediction_open() %}
                                    <small class="text-success">
                                        <i class="fas fa-unlock"></i> Deadline: {{ game.prediction_deadline.strftime('%H:%M') }}
                                    </small>
                                {% else %}
                                    <small class="text-danger">
                                        <i class="fas fa-lock"></i> Predictions Locked
                                    </small>
                                {% endif %}
                            </div>
                            {% if game.is_prediction_open() %}
        <form method="POST" action="{{ url_for('make_prediction') }}" class="prediction-form">
            <input type="hidden" name="game_id" value="{{ game.id }}">
            
            <div class="row">
                <!-- Team 1 Column -->
                <div class="col-md-5">
                    <div class="team-prediction-card text-center">
                        <div class="mb-3">
                            <h5 class="team-name fw-bold text-primary mb-2">
                                {% if get_country_code(game.team1) %}
                                    <span class="fi fi-{{ get_country_code(game.team1) }} team-flag-large"></span>
                                {% endif %}
                                {{ game.team1 }}
                            </h5>
                        </div>
                        <div class="prediction-input-section">
                            <label for="team1_score_{{ game.id }}" class="form-label fw-semibold mb-2">Sets Won</label>
                            <input type="number" name="team1_score" id="team1_score_{{ game.id }}" 
                                   class="form-control form-control-lg text-center score-input mb-2" 
                                   min="0" max="3" placeholder="0-3" required>
                            <small class="text-muted">Enter sets won (0-3)</small>
                        </div>
                    </div>
                </div>
                
                <!-- VS and Submit Column -->
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="vs-section mb-4">
                            <span class="vs-text h3 text-muted fw-bold">VS</span>
                        </div>
                        <div class="submit-section">
                            <button type="submit" class="btn btn-success w-100" id="submit_btn_{{ game.id }}">
                                <i class="fas fa-save"></i>
                                <span id="submit_text_{{ game.id }}">Save Prediction</span>
                            </button>
                            <div class="prediction-status mt-2" id="status_{{ game.id }}" style="display: none;">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="status_text_{{ game.id }}">Prediction saved</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Team 2 Column -->
                <div class="col-md-5">
                    <div class="team-prediction-card text-center">
                        <div class="mb-3">
                            <h5 class="team-name fw-bold text-primary mb-2">
                                {% if get_country_code(game.team2) %}
                                    <span class="fi fi-{{ get_country_code(game.team2) }} team-flag-large"></span>
                                {% endif %}
                                {{ game.team2 }}
                            </h5>
                        </div>
                        <div class="prediction-input-section">
                            <label for="team2_score_{{ game.id }}" class="form-label fw-semibold mb-2">Sets Won</label>
                            <input type="number" name="team2_score" id="team2_score_{{ game.id }}" 
                                   class="form-control form-control-lg text-center score-input mb-2" 
                                   min="0" max="3" placeholder="0-3" required>
                            <small class="text-muted">Enter sets won (0-3)</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info text-center py-2">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <strong>Volleyball Scoring:</strong> Winner must have 3 sets, loser 0-2 sets (3-0, 3-1, or 3-2)
                        </small>
                    </div>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-warning text-center">
            <i class="fas fa-lock"></i>
            Prediction deadline has passed for this game
        </div>
        
        {% if game.are_predictions_visible() %}
        <div class="mt-3">
            <button class="btn btn-info w-100" onclick="loadAllPredictions({{ game.id }})">
                <i class="fas fa-eye"></i> Show All Predictions
            </button>
            <div id="predictions_{{ game.id }}" class="mt-3" style="display: none;"></div>
        </div>
        {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endfor %}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Load user's existing prediction when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.prediction-form').forEach(form => {
        const gameId = form.querySelector('input[name="game_id"]').value;
        loadUserPrediction(gameId);
        
        // Add volleyball scoring validation
        addVolleyballValidation(form);
    });
});

function loadUserPrediction(gameId) {
    fetch(`/get_prediction/${gameId}`)
        .then(response => response.json())
        .then(data => {
            const team1Input = document.getElementById(`team1_score_${gameId}`);
            const team2Input = document.getElementById(`team2_score_${gameId}`);
            const submitText = document.getElementById(`submit_text_${gameId}`);
            const submitBtn = document.getElementById(`submit_btn_${gameId}`);
            const statusDiv = document.getElementById(`status_${gameId}`);
            const statusText = document.getElementById(`status_text_${gameId}`);
            
            if (data.team1_score !== null && data.team2_score !== null && data.team1_score !== '' && data.team2_score !== '') {
                // Existing prediction found
                team1Input.value = data.team1_score;
                team2Input.value = data.team2_score;
                
                // Update button and status
                submitText.textContent = 'Update Prediction';
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-warning');
                submitBtn.querySelector('i').classList.remove('fa-save');
                submitBtn.querySelector('i').classList.add('fa-edit');
                
                // Show status
                statusDiv.style.display = 'block';
                statusText.textContent = `Current: ${data.team1_score} - ${data.team2_score}`;
                
                // Add visual enhancement to form
                team1Input.classList.add('has-prediction');
                team2Input.classList.add('has-prediction');
                
                // Add visual enhancement to team cards
                const team1Card = team1Input.closest('.team-prediction-card');
                const team2Card = team2Input.closest('.team-prediction-card');
                if (team1Card) team1Card.classList.add('has-existing-prediction');
                if (team2Card) team2Card.classList.add('has-existing-prediction');
            } else {
                // No prediction exists
                team1Input.value = '';
                team2Input.value = '';
                
                // Reset button
                submitText.textContent = 'Save Prediction';
                submitBtn.classList.remove('btn-warning');
                submitBtn.classList.add('btn-success');
                submitBtn.querySelector('i').classList.remove('fa-edit');
                submitBtn.querySelector('i').classList.add('fa-save');
                
                // Hide status
                statusDiv.style.display = 'none';
                
                // Remove visual enhancement
                team1Input.classList.remove('has-prediction');
                team2Input.classList.remove('has-prediction');
                
                // Remove visual enhancement from team cards
                const team1Card = team1Input.closest('.team-prediction-card');
                const team2Card = team2Input.closest('.team-prediction-card');
                if (team1Card) team1Card.classList.remove('has-existing-prediction');
                if (team2Card) team2Card.classList.remove('has-existing-prediction');
            }
        })
        .catch(error => console.error('Error loading prediction:', error));
}

function loadAllPredictions(gameId) {
    const container = document.getElementById(`predictions_${gameId}`);
    
    fetch(`/game_predictions/${gameId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>Player</th><th>Prediction</th><th>Points</th></tr></thead><tbody>';
            
            data.predictions.forEach(pred => {
                const points = pred.points !== null ? pred.points : '-';
                html += `<tr>
                    <td><strong>${pred.user_name}</strong></td>
                    <td>${pred.team1_score} - ${pred.team2_score}</td>
                    <td><span class="badge bg-primary">${points}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            container.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading predictions:', error);
            container.innerHTML = '<div class="alert alert-danger">Error loading predictions</div>';
        });
}

// Countdown timer for deadlines
function updateCountdowns() {
    document.querySelectorAll('.deadline-countdown').forEach(element => {
        const deadline = new Date(element.dataset.deadline);
        const now = new Date();
        const diff = deadline - now;
        
        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            element.textContent = `${hours}h ${minutes}m remaining`;
            element.className = 'text-warning';
        } else {
            element.textContent = 'Deadline passed';
            element.className = 'text-danger';
        }
    });
}

// Update countdowns every minute
setInterval(updateCountdowns, 60000);
updateCountdowns();

function addVolleyballValidation(form) {
    const team1Input = form.querySelector('input[name="team1_score"]');
    const team2Input = form.querySelector('input[name="team2_score"]');
    
    // Only validate on form submission - no real-time validation to avoid UX issues
    form.addEventListener('submit', function(e) {
        const team1Value = team1Input.value.trim();
        const team2Value = team2Input.value.trim();
        
        // Clear any previous validation styling
        team1Input.classList.remove('is-valid', 'is-invalid');
        team2Input.classList.remove('is-valid', 'is-invalid');
        
        // Check if both fields are filled
        if (!team1Value || !team2Value) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Please fill in both score fields.');
            return;
        }
        
        const team1Score = parseInt(team1Value);
        const team2Score = parseInt(team2Value);
        
        // Check if values are valid numbers within range
        if (isNaN(team1Score) || isNaN(team2Score) || 
            team1Score < 0 || team1Score > 3 || 
            team2Score < 0 || team2Score > 3) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Please enter valid scores between 0 and 3.');
            return;
        }
        
        // Check if it's a valid volleyball score (one team has 3, other has 0-2)
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (!isValid) {
            e.preventDefault();
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            alert('Invalid volleyball score!\n\nValid scores:\n• 3-0 (sweep)\n• 3-1 (four sets)\n• 3-2 (five sets)\n\nWinner must have 3 sets, loser 0-2 sets.');
            return;
        }
        
        // If we get here, the form is valid - add success styling
        team1Input.classList.add('is-valid');
        team2Input.classList.add('is-valid');
        
        // Add a small delay to show success state before submission
        setTimeout(() => {
            // The form will submit and page will redirect
            // When user comes back, loadUserPrediction will show the updated state
        }, 500);
    });
}
</script>
{% endblock %}