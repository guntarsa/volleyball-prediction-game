{% extends "base.html" %}

{% block title %}Predictions - Volleyball Predictions{% endblock %}

{% block content %}
<h1 class="page-title">Make Your Predictions</h1>

{% if not games %}
<div class="alert alert-info text-center">
    <h4><i class="fas fa-calendar-times"></i> No Upcoming Games</h4>
    <p>There are no games available for predictions at the moment.</p>
    {% if current_user.is_admin %}
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Admin Panel</a>
    {% endif %}
</div>
{% else %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt"></i>
                    Upcoming Matches
                </h5>
            </div>
        </div>
    </div>
</div>

{% for game in games %}
<div class="card match-card">
    <div class="card-header text-center">
        <h6 class="mb-1 text-primary">{{ game.round_name }}</h6>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-calendar"></i>
                    {{ game.game_date.strftime('%b %d at %H:%M') }}
                </small>
            </div>
            <div class="col-md-6">
                {% if game.is_prediction_open() %}
                    <small class="text-success">
                        <i class="fas fa-unlock"></i>
                        Deadline: {{ game.prediction_deadline.strftime('%b %d at %H:%M') }}
                    </small>
                {% else %}
                    <small class="text-danger">
                        <i class="fas fa-lock"></i>
                        Predictions Locked
                    </small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if game.is_prediction_open() %}
        <form method="POST" action="{{ url_for('make_prediction') }}" class="prediction-form">
            <input type="hidden" name="game_id" value="{{ game.id }}">
            
            <div class="row">
                <div class="col-md-5">
                    <div class="text-center mb-3">
                        <h5 class="team-name fw-bold text-primary">
                            {% if get_country_code(game.team1) %}
                                <span class="fi fi-{{ get_country_code(game.team1) }} team-flag-large"></span>
                            {% endif %}
                            {{ game.team1 }}
                        </h5>
                    </div>
                    <div class="text-center">
                        <label for="team1_score_{{ game.id }}" class="form-label fw-semibold">Sets Won</label>
                        <input type="number" name="team1_score" id="team1_score_{{ game.id }}" 
                               class="form-control form-control-lg text-center score-input" 
                               min="0" max="3" placeholder="0-3" required>
                        <small class="text-muted d-block mt-1">Enter sets won (0-3)</small>
                    </div>
                </div>
                
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <span class="vs-text h3 text-muted fw-bold">VS</span>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-save"></i><br>
                                <small>Save</small>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <div class="text-center mb-3">
                        <h5 class="team-name fw-bold text-primary">
                            {% if get_country_code(game.team2) %}
                                <span class="fi fi-{{ get_country_code(game.team2) }} team-flag-large"></span>
                            {% endif %}
                            {{ game.team2 }}
                        </h5>
                    </div>
                    <div class="text-center">
                        <label for="team2_score_{{ game.id }}" class="form-label fw-semibold">Sets Won</label>
                        <input type="number" name="team2_score" id="team2_score_{{ game.id }}" 
                               class="form-control form-control-lg text-center score-input" 
                               min="0" max="3" placeholder="0-3" required>
                        <small class="text-muted d-block mt-1">Enter sets won (0-3)</small>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info text-center py-2">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <strong>Volleyball Scoring:</strong> Winner must have 3 sets, loser 0-2 sets (3-0, 3-1, or 3-2)
                        </small>
                    </div>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-warning text-center">
            <i class="fas fa-lock"></i>
            Prediction deadline has passed for this game
        </div>
        
        {% if game.are_predictions_visible() %}
        <div class="mt-3">
            <button class="btn btn-info w-100" onclick="loadAllPredictions({{ game.id }})">
                <i class="fas fa-eye"></i> Show All Predictions
            </button>
            <div id="predictions_{{ game.id }}" class="mt-3" style="display: none;"></div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endfor %}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Load user's existing prediction when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.prediction-form').forEach(form => {
        const gameId = form.querySelector('input[name="game_id"]').value;
        loadUserPrediction(gameId);
        
        // Add volleyball scoring validation
        addVolleyballValidation(form);
    });
});

function loadUserPrediction(gameId) {
    fetch(`/get_prediction/${gameId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById(`team1_score_${gameId}`).value = data.team1_score || '';
            document.getElementById(`team2_score_${gameId}`).value = data.team2_score || '';
        })
        .catch(error => console.error('Error loading prediction:', error));
}

function loadAllPredictions(gameId) {
    const container = document.getElementById(`predictions_${gameId}`);
    
    fetch(`/game_predictions/${gameId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>Player</th><th>Prediction</th><th>Points</th></tr></thead><tbody>';
            
            data.predictions.forEach(pred => {
                const points = pred.points !== null ? pred.points : '-';
                html += `<tr>
                    <td><strong>${pred.user_name}</strong></td>
                    <td>${pred.team1_score} - ${pred.team2_score}</td>
                    <td><span class="badge bg-primary">${points}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            container.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading predictions:', error);
            container.innerHTML = '<div class="alert alert-danger">Error loading predictions</div>';
        });
}

// Countdown timer for deadlines
function updateCountdowns() {
    document.querySelectorAll('.deadline-countdown').forEach(element => {
        const deadline = new Date(element.dataset.deadline);
        const now = new Date();
        const diff = deadline - now;
        
        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            element.textContent = `${hours}h ${minutes}m remaining`;
            element.className = 'text-warning';
        } else {
            element.textContent = 'Deadline passed';
            element.className = 'text-danger';
        }
    });
}

// Update countdowns every minute
setInterval(updateCountdowns, 60000);
updateCountdowns();

function addVolleyballValidation(form) {
    const team1Input = form.querySelector('input[name="team1_score"]');
    const team2Input = form.querySelector('input[name="team2_score"]');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    function validateVolleyballScore() {
        const team1Value = team1Input.value.trim();
        const team2Value = team2Input.value.trim();
        
        // Reset all styling first
        team1Input.classList.remove('is-valid', 'is-invalid');
        team2Input.classList.remove('is-valid', 'is-invalid');
        submitBtn.disabled = false;
        
        // If either field is empty, don't show any validation styling
        if (!team1Value || !team2Value) {
            return;
        }
        
        const team1Score = parseInt(team1Value);
        const team2Score = parseInt(team2Value);
        
        // Check if values are valid numbers within range
        if (isNaN(team1Score) || isNaN(team2Score) || 
            team1Score < 0 || team1Score > 3 || 
            team2Score < 0 || team2Score > 3) {
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            submitBtn.disabled = true;
            return;
        }
        
        // Check if it's a valid volleyball score (one team has 3, other has 0-2)
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (isValid) {
            team1Input.classList.add('is-valid');
            team2Input.classList.add('is-valid');
            submitBtn.disabled = false;
        } else {
            team1Input.classList.add('is-invalid');
            team2Input.classList.add('is-invalid');
            submitBtn.disabled = true;
        }
    }
    
    team1Input.addEventListener('input', validateVolleyballScore);
    team2Input.addEventListener('input', validateVolleyballScore);
    team1Input.addEventListener('blur', validateVolleyballScore);
    team2Input.addEventListener('blur', validateVolleyballScore);
    
    // Prevent form submission with invalid scores
    form.addEventListener('submit', function(e) {
        const team1Value = team1Input.value.trim();
        const team2Value = team2Input.value.trim();
        
        if (!team1Value || !team2Value) {
            e.preventDefault();
            alert('Please fill in both score fields.');
            return;
        }
        
        const team1Score = parseInt(team1Value);
        const team2Score = parseInt(team2Value);
        
        if (isNaN(team1Score) || isNaN(team2Score) || 
            team1Score < 0 || team1Score > 3 || 
            team2Score < 0 || team2Score > 3) {
            e.preventDefault();
            alert('Please enter valid scores between 0 and 3.');
            return;
        }
        
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (!isValid) {
            e.preventDefault();
            alert('Invalid volleyball score! Winner must have 3 sets, loser 0-2 sets.');
        }
    });
}
</script>
{% endblock %}