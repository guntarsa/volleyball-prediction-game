{% extends "base.html" %}

{% block title %}Admin - Men's World Championship 2025{% endblock %}

{% block content %}
<h1 class="page-title">Admin Panel</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload"></i>
                    Import Games from CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_games') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select CSV File:</label>
                        <input type="file" name="file" id="file" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            CSV should have columns: team1, team2, date, time, round, prediction_deadline
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-import"></i> Import Games
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    CSV Format Example
                </h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>team1,team2,date,time,round,prediction_deadline
Brazil,Italy,2024-09-15,14:00,Quarter Final 1,2024-09-15,13:30
USA,Poland,2024-09-15,17:00,Quarter Final 2,2024-09-15,16:30
Serbia,Turkey,2024-09-16,14:00,Quarter Final 3,2024-09-16,13:30</code></pre>
                <small class="text-muted">
                    <i class="fas fa-calendar"></i> Date format: YYYY-MM-DD<br>
                    <i class="fas fa-clock"></i> Time format: HH:MM (24-hour)<br>
                    <i class="fas fa-stopwatch"></i> Prediction deadline: YYYY-MM-DD HH:MM
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i>
                    Tournament Configuration
                </h5>
            </div>
            <div class="card-body">
                {% if tournament_config %}
                    <div class="alert alert-info">
                        <strong>Current Deadline:</strong> {{ tournament_config.prediction_deadline.strftime('%Y-%m-%d %H:%M') }}<br>
                        <strong>Status:</strong> 
                        {% if tournament_config.is_prediction_open() %}
                            <span class="badge bg-success">Open</span>
                        {% else %}
                            <span class="badge bg-danger">Closed</span>
                        {% endif %}
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('set_tournament_config') }}">
                    <div class="mb-3">
                        <label for="prediction_deadline" class="form-label">Tournament Prediction Deadline:</label>
                        <input type="datetime-local" name="prediction_deadline" id="prediction_deadline" 
                               class="form-control" required
                               value="{% if tournament_config %}{{ tournament_config.prediction_deadline.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                        <div class="form-text">Users can predict until this date/time</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-clock"></i> Set Deadline
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-medal"></i>
                    Tournament Results
                </h5>
            </div>
            <div class="card-body">
                {% if tournament_config and tournament_config.are_results_available() %}
                    <div class="alert alert-success">
                        <strong>Results Finalized:</strong><br>
                        1st: {{ tournament_config.first_place_result }}<br>
                        2nd: {{ tournament_config.second_place_result }}<br>
                        3rd: {{ tournament_config.third_place_result }}
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('set_tournament_results') }}">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="first_place_result" class="form-label">1st Place (Winner):</label>
                            <select name="first_place_result" class="form-select" required>
                                <option value="">Select winner...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.first_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="second_place_result" class="form-label">2nd Place (Runner-up):</label>
                            <select name="second_place_result" class="form-select" required>
                                <option value="">Select runner-up...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.second_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="third_place_result" class="form-label">3rd Place (Bronze):</label>
                            <select name="third_place_result" class="form-select" required>
                                <option value="">Select bronze medalist...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.third_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-trophy"></i> Finalize Results
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calculator"></i>
                    Points Recalculation
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Default Points System:</strong> Players who didn't make predictions will receive points equal to the Nth worst performing players for each game.
                </div>
                
                <form id="recalculationConfigForm">
                    <div class="mb-3">
                        <label for="default_points_position" class="form-label">Default Points Position (N):</label>
                        <input type="number" name="default_points_position" id="default_points_position" 
                               class="form-control" min="1" max="10" 
                               value="{{ recalculation_config.default_points_position if recalculation_config else 1 }}" required>
                        <div class="form-text">
                            <strong>N=1:</strong> Non-predictors get points equal to worst performers<br>
                            <strong>N=2:</strong> Non-predictors get points equal to 2nd worst performers<br>
                            <strong>N=3:</strong> Non-predictors get points equal to 3rd worst performers, etc.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-warning" onclick="showRecalculationConfirm()">
                            <i class="fas fa-calculator"></i> Recalculate All Points
                        </button>
                        <small class="text-muted ms-2">This will recalculate points for all finished games</small>
                    </div>
                </form>
                
                <!-- Status display area -->
                <div id="recalculationStatus" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i>
                    Current Points System
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Regular Game Predictions:</h6>
                    <ul class="list-unstyled mb-3">
                        <li><span class="badge bg-success me-2">6</span>Perfect prediction (exact score match)</li>
                        <li><span class="badge bg-primary me-2">4</span>Correct winner + missed by 1 set</li>
                        <li><span class="badge bg-info me-2">2</span>Correct winner only</li>
                        <li><span class="badge bg-warning me-2">1</span>Wrong winner but correct total sets</li>
                        <li><span class="badge bg-danger me-2">0</span>Completely wrong prediction</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <h6>Non-Prediction Handling:</h6>
                    <p class="text-muted mb-0">
                        <i class="fas fa-arrow-right me-1"></i>
                        Players without predictions receive default points based on Nth worst performance for each game.
                    </p>
                </div>
                
                <div class="alert alert-warning">
                    <small>
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> Recalculation will affect all user scores and leaderboard positions.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i>
                    Tournament Teams
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_tournament_teams') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="teams_file" class="form-label">Upload Teams CSV:</label>
                        <input type="file" name="file" id="teams_file" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            CSV should have column: team_name, name, or team
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Import Teams
                    </button>
                </form>
                
                {% if tournament_teams %}
                <div class="mt-4">
                    <h6><i class="fas fa-list"></i> Current Teams ({{ tournament_teams|length }})</h6>
                    <div class="row">
                        {% for team in tournament_teams %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                <span class="fw-bold">
                                    {% if team.get_country_code() %}
                                        <span class="fi fi-{{ team.get_country_code() }} team-flag"></span>
                                    {% endif %}
                                    {{ team.name }}
                                </span>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmTeamDelete({{ team.id }}, '{{ team.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="mt-3 alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No tournament teams uploaded yet. Upload a CSV file with team names.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    Teams CSV Format
                </h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>team_name,country_code
Brazil,br
USA,us
Poland,pl
Italy,it
Serbia,rs
Turkey,tr
Japan,jp
China,cn
Netherlands,nl
Dominican Republic,do
...</code></pre>
                <small class="text-muted">
                    <i class="fas fa-users"></i> Expected: 24 teams for tournament<br>
                    <i class="fas fa-file-csv"></i> Format: team_name required, country_code optional<br>
                    <i class="fas fa-flag"></i> Country codes auto-detected if not provided<br>
                    <i class="fas fa-trophy"></i> Used for tournament predictions
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i>
                    Manage Users
                </h5>
            </div>
            <div class="card-body">
                {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Password Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td><strong>{{ user.name }}</strong></td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.is_admin %}
                                        <span class="badge bg-warning text-dark">Admin</span>
                                    {% else %}
                                        <span class="badge bg-secondary">User</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if user.password_reset_required %}
                                        <span class="badge bg-danger">Reset Required</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not user.is_admin %}
                                        {% if user.password_reset_required %}
                                            <span class="text-muted">
                                                <i class="fas fa-clock"></i> Awaiting password change
                                            </span>
                                        {% else %}
                                            <button class="btn btn-sm btn-warning" onclick="confirmPasswordReset({{ user.id }}, '{{ user.name }}')">
                                                <i class="fas fa-key"></i> Reset Password
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Admin user</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <h4><i class="fas fa-users"></i> No Users Found</h4>
                    <p>No users have registered yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Manage Predictions Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-edit"></i>
                    Manage User Predictions
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Admin Override:</strong> Create or update predictions for any user, even after deadline has passed.
                </div>
                
                <form id="predictionForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="user_id" class="form-label">Select User:</label>
                                <select name="user_id" id="user_id" class="form-select" required onchange="loadPrediction()">
                                    <option value="">-- Select User --</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="game_id" class="form-label">Select Game:</label>
                                <select name="game_id" id="game_id" class="form-select" required onchange="loadPrediction()">
                                    <option value="">-- Select Game --</option>
                                    {% for game in games %}
                                        <option value="{{ game.id }}" 
                                                data-team1="{{ game.team1 }}" 
                                                data-team2="{{ game.team2 }}"
                                                data-finished="{{ 'true' if game.is_finished else 'false' }}"
                                                data-deadline-passed="{{ 'true' if not game.is_prediction_open() else 'false' }}">
                                            {{ game.team1 }} vs {{ game.team2 }} - {{ game.game_date.strftime('%m/%d %H:%M') }}
                                            {% if not game.is_prediction_open() %}
                                                <span class="text-danger">(Deadline Passed)</span>
                                            {% endif %}
                                            {% if game.is_finished %}
                                                <span class="text-success">(Finished)</span>
                                            {% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="team1_score" class="form-label">
                                    <span id="team1_name">Team 1</span> Score:
                                </label>
                                <input type="number" name="team1_score" id="team1_score" class="form-control" 
                                       min="0" max="3" required placeholder="0-3">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="team2_score" class="form-label">
                                    <span id="team2_name">Team 2</span> Score:
                                </label>
                                <input type="number" name="team2_score" id="team2_score" class="form-control" 
                                       min="0" max="3" required placeholder="0-3">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Action:</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary" id="predictionSubmitBtn">
                                        <i class="fas fa-save"></i> Save Prediction
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Prediction Display -->
                    <div id="currentPrediction" class="mt-3" style="display: none;">
                        <div class="alert alert-secondary">
                            <strong>Current Prediction:</strong>
                            <span id="currentPredictionText"></span>
                            <span id="currentPoints" class="ms-2"></span>
                        </div>
                    </div>
                    
                    <!-- Game Status Display -->
                    <div id="gameStatus" class="mt-2" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    Deadline Status: <span id="deadlineStatus"></span>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="fas fa-trophy"></i> 
                                    Game Status: <span id="finishedStatus"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prediction form status message area -->
                    <div id="predictionStatus" class="mt-3" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-gamepad"></i>
                    Manage Games
                </h5>
            </div>
            <div class="card-body">
                {% if games %}
                <div class="mb-3">
                    <button id="bulkDeleteBtn" class="btn btn-danger" onclick="bulkDeleteGames()" style="display: none;">
                        <i class="fas fa-trash"></i> 
                        <span class="d-none d-sm-inline">Delete Selected Games</span>
                        <span class="d-sm-none">Delete Selected</span>
                    </button>
                    <span id="selectedCount" class="text-muted ms-2"></span>
                </div>
                
                <!-- Hidden form for bulk delete -->
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('bulk_delete_games') }}" style="display: none;">
                </form>
                
                <!-- Desktop Table View -->
                <div class="table-responsive d-none d-lg-block">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleAllGames()">
                                </th>
                                <th>Date & Time</th>
                                <th>Deadline</th>
                                <th>Round</th>
                                <th>Teams</th>
                                <th>Result</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in games %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="game-checkbox" value="{{ game.id }}" onchange="updateBulkDeleteButton()">
                                </td>
                                <td>
                                    <small>{{ game.game_date.strftime('%Y-%m-%d') }}</small><br>
                                    <strong>{{ game.game_date.strftime('%H:%M') }}</strong>
                                </td>
                                <td>
                                    <small>{{ game.prediction_deadline.strftime('%m-%d') }}</small><br>
                                    <strong>{{ game.prediction_deadline.strftime('%H:%M') }}</strong>
                                    {% if game.is_prediction_open() %}
                                        <br><span class="badge bg-success">Open</span>
                                    {% else %}
                                        <br><span class="badge bg-danger">Closed</span>
                                    {% endif %}
                                </td>
                                <td>{{ game.round_name }}</td>
                                <td>
                                    <strong>
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team1 }}
                                    </strong> vs <strong>
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team2 }}
                                    </strong>
                                </td>
                                <td>
                                    {% if game.is_finished %}
                                        <span class="badge bg-success">{{ game.team1_score }} - {{ game.team2_score }}</span>
                                    {% else %}
                                        <span class="text-muted">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if game.is_finished %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Finished
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock"></i> Upcoming
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if not game.is_finished %}
                                        <button class="btn btn-sm btn-primary" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                            <i class="fas fa-edit"></i> Update Result
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}', {{ game.team1_score }}, {{ game.team2_score }})">
                                            <i class="fas fa-edit"></i> Edit Result
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View -->
                <div class="d-lg-none">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="selectAllMobile" onchange="toggleAllGames()">
                                <label class="form-check-label fw-bold" for="selectAllMobile">
                                    Select All Games
                                </label>
                            </div>
                        </div>
                    </div>
                    {% for game in games %}
                    <div class="card mb-3 mobile-game-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input game-checkbox" value="{{ game.id }}" 
                                           onchange="updateBulkDeleteButton()" id="gameCheck{{ game.id }}">
                                    <label class="form-check-label fw-bold" for="gameCheck{{ game.id }}">
                                        {{ game.round_name }}
                                    </label>
                                </div>
                                <div class="text-end">
                                    {% if game.is_finished %}
                                        <span class="badge bg-success mb-1">
                                            <i class="fas fa-check"></i> Finished
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark mb-1">
                                            <i class="fas fa-clock"></i> Upcoming
                                        </span>
                                    {% endif %}
                                    {% if game.is_prediction_open() %}
                                        <span class="badge bg-success d-block">
                                            <i class="fas fa-unlock"></i> Open
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger d-block">
                                            <i class="fas fa-lock"></i> Closed
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Game Date</small>
                                    <div class="fw-bold">{{ game.game_date.strftime('%m/%d') }}</div>
                                    <div>{{ game.game_date.strftime('%H:%M') }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Deadline</small>
                                    <div class="fw-bold">{{ game.prediction_deadline.strftime('%m/%d') }}</div>
                                    <div>{{ game.prediction_deadline.strftime('%H:%M') }}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="team-info">
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag me-1"></span>
                                        {% endif %}
                                        <strong>{{ game.team1 }}</strong>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted">VS</small>
                                        {% if game.is_finished %}
                                            <div class="badge bg-success">{{ game.team1_score }} - {{ game.team2_score }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="team-info text-end">
                                        <strong>{{ game.team2 }}</strong>
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag ms-1"></span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                {% if not game.is_finished %}
                                <button class="btn btn-primary btn-sm" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                    <i class="fas fa-edit"></i> Update Result
                                </button>
                                {% else %}
                                <button class="btn btn-secondary btn-sm" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}', {{ game.team1_score }}, {{ game.team2_score }})">
                                    <i class="fas fa-edit"></i> Edit Result
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <h4><i class="fas fa-calendar-times"></i> No Games Found</h4>
                    <p>Import games using the CSV upload feature above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Update Result Modal -->
<div class="modal fade" id="updateResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Game Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateResultForm">
                <div class="modal-body">
                    <input type="hidden" name="game_id" id="modalGameId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label" id="team1Label">Team 1 Sets:</label>
                            <input type="number" name="team1_score" id="modalTeam1Score" class="form-control" min="0" max="3" required>
                            <small class="text-muted">Sets won (0-3)</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" id="team2Label">Team 2 Sets:</label>
                            <input type="number" name="team2_score" id="modalTeam2Score" class="form-control" min="0" max="3" required>
                            <small class="text-muted">Sets won (0-3)</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <strong>Volleyball Scoring:</strong> Winner must have 3 sets, loser 0-2 sets (3-0, 3-1, or 3-2).<br>
                            Updating the result will automatically recalculate points for all predictions.
                        </small>
                    </div>
                    
                    <!-- Status message area -->
                    <div id="updateResultStatus" class="mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="updateResultBtn">Update Result</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Game</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="deleteGameForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to delete this game?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="deleteGameInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Note: Games with existing predictions cannot be deleted.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Game
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Reset Confirmation Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="passwordResetForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Password Reset</strong>
                    </div>
                    <p>Are you sure you want to reset the password for this user?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="resetUserInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            The user will be prompted to set a new password on their next login.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team Delete Confirmation Modal -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Tournament Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="deleteTeamForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to delete this tournament team?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="deleteTeamInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Note: Teams referenced in tournament predictions cannot be deleted.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Team
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showUpdateModal(gameId, team1, team2, team1Score = '', team2Score = '') {
    document.getElementById('modalGameId').value = gameId;
    document.getElementById('team1Label').textContent = team1 + ' Sets:';
    document.getElementById('team2Label').textContent = team2 + ' Sets:';
    document.getElementById('modalTeam1Score').value = team1Score;
    document.getElementById('modalTeam2Score').value = team2Score;
    
    // Clear any previous status messages
    const statusDiv = document.getElementById('updateResultStatus');
    statusDiv.style.display = 'none';
    statusDiv.innerHTML = '';
    
    // Reset button state
    const submitBtn = document.getElementById('updateResultBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Update Result';
    
    // Add volleyball validation to modal
    addModalVolleyballValidation();
    
    new bootstrap.Modal(document.getElementById('updateResultModal')).show();
}

function confirmDelete(gameId, team1, team2) {
    document.getElementById('deleteGameForm').action = `/delete_game/${gameId}`;
    document.getElementById('deleteGameInfo').textContent = `${team1} vs ${team2}`;
    
    new bootstrap.Modal(document.getElementById('deleteGameModal')).show();
}

function toggleAllGames() {
    // Handle both desktop and mobile select all checkboxes
    const selectAll = document.getElementById('selectAll');
    const selectAllMobile = document.getElementById('selectAllMobile');
    const checkboxes = document.querySelectorAll('.game-checkbox');
    
    // Determine which select all was clicked
    let isChecked = false;
    if (event && event.target) {
        isChecked = event.target.checked;
        // Sync both select all checkboxes
        if (selectAll) selectAll.checked = isChecked;
        if (selectAllMobile) selectAllMobile.checked = isChecked;
    } else {
        // Fallback: use desktop checkbox state
        isChecked = selectAll ? selectAll.checked : false;
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const checkboxes = document.querySelectorAll('.game-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectedCount = document.getElementById('selectedCount');
    
    if (checkboxes.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
        selectedCount.textContent = `${checkboxes.length} game(s) selected`;
    } else {
        bulkDeleteBtn.style.display = 'none';
        selectedCount.textContent = '';
    }
}

function bulkDeleteGames() {
    const checkboxes = document.querySelectorAll('.game-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one game to delete.');
        return;
    }
    
    const gameCount = checkboxes.length;
    const gameIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (!confirm(`Are you sure you want to delete ${gameCount} selected game(s)? This action cannot be undone.\n\nGame IDs: ${gameIds.join(', ')}`)) {
        return;
    }
    
    // Use the existing form and clear any previous inputs
    const form = document.getElementById('bulkDeleteForm');
    form.innerHTML = ''; // Clear any existing inputs
    
    checkboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'game_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    // Debug: log form data before submission
    console.log('Submitting bulk delete for games:', gameIds);
    console.log('Form action:', form.action);
    console.log('Form method:', form.method);
    
    form.submit();
}

function addModalVolleyballValidation() {
    const team1Input = document.getElementById('modalTeam1Score');
    const team2Input = document.getElementById('modalTeam2Score');
    const modal = document.getElementById('updateResultModal');
    const submitBtn = modal.querySelector('button[type="submit"]');
    
    function validateModalScore() {
        const team1Score = parseInt(team1Input.value) || 0;
        const team2Score = parseInt(team2Input.value) || 0;
        
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (team1Input.value && team2Input.value) {
            if (isValid) {
                team1Input.classList.remove('is-invalid');
                team2Input.classList.remove('is-invalid');
                team1Input.classList.add('is-valid');
                team2Input.classList.add('is-valid');
                submitBtn.disabled = false;
            } else {
                team1Input.classList.remove('is-valid');
                team2Input.classList.remove('is-valid');
                team1Input.classList.add('is-invalid');
                team2Input.classList.add('is-invalid');
                submitBtn.disabled = true;
            }
        } else {
            team1Input.classList.remove('is-valid', 'is-invalid');
            team2Input.classList.remove('is-valid', 'is-invalid');
            submitBtn.disabled = false;
        }
    }
    
    team1Input.addEventListener('input', validateModalScore);
    team2Input.addEventListener('input', validateModalScore);
    
    // Handle AJAX form submission
    modal.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const team1Score = parseInt(team1Input.value) || 0;
        const team2Score = parseInt(team2Input.value) || 0;
        
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (!isValid) {
            showUpdateResultError('Invalid volleyball score! Winner must have 3 sets, loser 0-2 sets.');
            return;
        }
        
        handleUpdateResult(this);
    });
}

function confirmPasswordReset(userId, userName) {
    document.getElementById('passwordResetForm').action = `/admin/reset-user-password/${userId}`;
    document.getElementById('resetUserInfo').textContent = userName;
    
    new bootstrap.Modal(document.getElementById('passwordResetModal')).show();
}

function confirmTeamDelete(teamId, teamName) {
    document.getElementById('deleteTeamForm').action = `/delete_tournament_team/${teamId}`;
    document.getElementById('deleteTeamInfo').textContent = teamName;
    
    new bootstrap.Modal(document.getElementById('deleteTeamModal')).show();
}

// Prediction Management Functions
function loadPrediction() {
    const userSelect = document.getElementById('user_id');
    const gameSelect = document.getElementById('game_id');
    const team1ScoreInput = document.getElementById('team1_score');
    const team2ScoreInput = document.getElementById('team2_score');
    const team1NameSpan = document.getElementById('team1_name');
    const team2NameSpan = document.getElementById('team2_name');
    const currentPredictionDiv = document.getElementById('currentPrediction');
    const gameStatusDiv = document.getElementById('gameStatus');
    const deadlineStatusSpan = document.getElementById('deadlineStatus');
    const finishedStatusSpan = document.getElementById('finishedStatus');
    const currentPredictionText = document.getElementById('currentPredictionText');
    const currentPointsSpan = document.getElementById('currentPoints');
    
    if (!userSelect.value || !gameSelect.value) {
        currentPredictionDiv.style.display = 'none';
        gameStatusDiv.style.display = 'none';
        team1ScoreInput.value = '';
        team2ScoreInput.value = '';
        team1NameSpan.textContent = 'Team 1';
        team2NameSpan.textContent = 'Team 2';
        return;
    }
    
    // Update team names
    const selectedOption = gameSelect.options[gameSelect.selectedIndex];
    const team1 = selectedOption.dataset.team1;
    const team2 = selectedOption.dataset.team2;
    const isFinished = selectedOption.dataset.finished === 'true';
    const deadlinePassed = selectedOption.dataset.deadlinePassed === 'true';
    
    team1NameSpan.textContent = team1;
    team2NameSpan.textContent = team2;
    
    // Show game status
    gameStatusDiv.style.display = 'block';
    deadlineStatusSpan.innerHTML = deadlinePassed 
        ? '<span class="text-danger">Passed</span>' 
        : '<span class="text-success">Open</span>';
    finishedStatusSpan.innerHTML = isFinished 
        ? '<span class="text-success">Finished</span>' 
        : '<span class="text-warning">Upcoming</span>';
    
    // Fetch existing prediction
    fetch(`/admin/get_prediction?user_id=${userSelect.value}&game_id=${gameSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.team1_score !== '' && data.team2_score !== '') {
                    // Show existing prediction
                    currentPredictionDiv.style.display = 'block';
                    currentPredictionText.textContent = `${data.team1_score} - ${data.team2_score}`;
                    if (data.points !== null) {
                        currentPointsSpan.innerHTML = `<span class="badge bg-info">${data.points} points</span>`;
                    } else {
                        currentPointsSpan.innerHTML = '<span class="badge bg-secondary">Not scored yet</span>';
                    }
                    
                    // Pre-fill form with existing values
                    team1ScoreInput.value = data.team1_score;
                    team2ScoreInput.value = data.team2_score;
                } else {
                    // No existing prediction
                    currentPredictionDiv.style.display = 'block';
                    currentPredictionText.textContent = 'No prediction exists';
                    currentPointsSpan.innerHTML = '<span class="badge bg-light text-dark">New prediction</span>';
                    team1ScoreInput.value = '';
                    team2ScoreInput.value = '';
                }
            } else {
                console.error('Error loading prediction:', data.error);
                currentPredictionDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            currentPredictionDiv.style.display = 'none';
        });
}

// Add volleyball score validation for prediction form
document.addEventListener('DOMContentLoaded', function() {
    const predictionForm = document.getElementById('predictionForm');
    if (predictionForm) {
        const team1Input = predictionForm.querySelector('#team1_score');
        const team2Input = predictionForm.querySelector('#team2_score');
        
        function validatePredictionScore() {
            const team1Score = parseInt(team1Input.value) || 0;
            const team2Score = parseInt(team2Input.value) || 0;
            
            const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                           (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
            
            if (team1Input.value && team2Input.value) {
                if (isValid) {
                    team1Input.classList.remove('is-invalid');
                    team2Input.classList.remove('is-invalid');
                    team1Input.classList.add('is-valid');
                    team2Input.classList.add('is-valid');
                } else {
                    team1Input.classList.remove('is-valid');
                    team2Input.classList.remove('is-valid');
                    team1Input.classList.add('is-invalid');
                    team2Input.classList.add('is-invalid');
                }
            } else {
                team1Input.classList.remove('is-valid', 'is-invalid');
                team2Input.classList.remove('is-valid', 'is-invalid');
            }
        }
        
        team1Input.addEventListener('input', validatePredictionScore);
        team2Input.addEventListener('input', validatePredictionScore);
        
        // Handle AJAX form submission
        predictionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const team1Score = parseInt(team1Input.value) || 0;
            const team2Score = parseInt(team2Input.value) || 0;
            
            const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                           (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
            
            if (!isValid) {
                showPredictionError('Invalid volleyball score! Winner must have 3 sets, loser 0-2 sets.');
                return;
            }
            
            handlePredictionSubmit(this);
        });
    }
});

// AJAX handlers for maintaining scroll position
function handleUpdateResult(form) {
    const gameId = document.getElementById('modalGameId').value;
    const team1Score = document.getElementById('modalTeam1Score').value;
    const team2Score = document.getElementById('modalTeam2Score').value;
    const submitBtn = document.getElementById('updateResultBtn');
    const statusDiv = document.getElementById('updateResultStatus');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    
    // Make AJAX request
    fetch('/update_result', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `game_id=${gameId}&team1_score=${team1Score}&team2_score=${team2Score}`
    })
    .then(response => {
        if (response.ok) {
            return response.text();
        }
        throw new Error('Network response was not ok');
    })
    .then(data => {
        // Show success message
        showUpdateResultSuccess('Game result updated successfully! Page will refresh in 2 seconds...');
        
        // Close modal and refresh page after delay to show updated data
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('updateResultModal')).hide();
            location.reload();
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        showUpdateResultError('Failed to update game result. Please try again.');
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Update Result';
    });
}

function handlePredictionSubmit(form) {
    const formData = new FormData(form);
    const userSelect = document.getElementById('user_id');
    const gameSelect = document.getElementById('game_id');
    const submitBtn = document.getElementById('predictionSubmitBtn');
    const statusDiv = document.getElementById('predictionStatus');
    
    if (!userSelect.value || !gameSelect.value) {
        showPredictionError('Please select both user and game.');
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Prepare form data
    const params = new URLSearchParams();
    params.append('user_id', userSelect.value);
    params.append('game_id', gameSelect.value);
    params.append('team1_score', formData.get('team1_score'));
    params.append('team2_score', formData.get('team2_score'));
    
    // Make AJAX request
    fetch('/admin/manage_prediction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString()
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        return response.json().then(err => Promise.reject(err));
    })
    .then(data => {
        if (data.success) {
            // Show success message
            showPredictionSuccess(data.message || 'Prediction saved successfully!');

            // Reload the current prediction to show updated state
            loadPrediction();
        } else {
            showPredictionError(data.error || 'Failed to save prediction');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error && error.error) {
            showPredictionError(error.error);
        } else {
            showPredictionError('Failed to save prediction. Please try again.');
        }
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Prediction';
    });
}

function showUpdateResultSuccess(message) {
    const statusDiv = document.getElementById('updateResultStatus');
    statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${message}</div>`;
    statusDiv.style.display = 'block';
}

function showUpdateResultError(message) {
    const statusDiv = document.getElementById('updateResultStatus');
    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
    statusDiv.style.display = 'block';
}

function showPredictionSuccess(message) {
    const statusDiv = document.getElementById('predictionStatus');
    statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${message}</div>`;
    statusDiv.style.display = 'block';
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 4000);
}

function showPredictionError(message) {
    const statusDiv = document.getElementById('predictionStatus');
    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
    statusDiv.style.display = 'block';
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 4000);
}

// Recalculation functionality
function showRecalculationConfirm() {
    const nPosition = document.getElementById('default_points_position').value;
    
    if (!nPosition || nPosition < 1) {
        showRecalculationError('Please enter a valid position value (1 or higher)');
        return;
    }
    
    const message = `Are you sure you want to recalculate all points?\n\n` +
                   `Configuration:\n` +
                   ` Default Points Position: ${nPosition}\n` +
                   ` Non-predictors will get points equal to ${getPositionText(nPosition)} performers\n\n` +
                   `This will:\n` +
                   ` Recalculate points for all existing predictions\n` +
                   ` Create predictions with default points for users who didn't predict\n` +
                   ` Affect all user scores and leaderboard positions\n\n` +
                   `This action cannot be undone!`;
    
    if (confirm(message)) {
        handleRecalculationSubmit();
    }
}

function getPositionText(n) {
    if (n == 1) return "worst";
    if (n == 2) return "2nd worst";
    if (n == 3) return "3rd worst";
    return `${n}th worst`;
}

function handleRecalculationSubmit() {
    const nPosition = document.getElementById('default_points_position').value;
    const statusDiv = document.getElementById('recalculationStatus');
    
    // Show loading state
    showRecalculationStatus('info', '<i class="fas fa-spinner fa-spin"></i> Recalculating points... This may take a few moments.');
    
    // Prepare form data
    const formData = new FormData();
    formData.append('default_points_position', nPosition);
    
    // Make AJAX request
    fetch('/admin/recalculate_points', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = data.details;
            const message = `${data.message}<br><br>` +
                          `<strong>Summary:</strong><br>` +
                          ` Games processed: ${details.games_processed}<br>` +
                          ` New predictions created: ${details.predictions_created}<br>` +
                          ` Points updated: ${details.points_updated}<br>` +
                          ` Position used: ${details.n_position} (${getPositionText(details.n_position)})`;
            
            showRecalculationStatus('success', message);
            
            // Auto-refresh page after 3 seconds to show updated data
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            showRecalculationError(data.error || 'Recalculation failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showRecalculationError('Network error occurred. Please try again.');
    });
}

function showRecalculationStatus(type, message) {
    const statusDiv = document.getElementById('recalculationStatus');
    let alertClass = 'alert-info';
    let icon = 'fas fa-info-circle';
    
    if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'fas fa-check-circle';
    } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'fas fa-exclamation-triangle';
    }
    
    statusDiv.innerHTML = `<div class="alert ${alertClass}"><i class="${icon}"></i> ${message}</div>`;
    statusDiv.style.display = 'block';
}

function showRecalculationError(message) {
    showRecalculationStatus('error', message);
}

// Load configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load current recalculation configuration
    fetch('/admin/recalculation_config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('default_points_position').value = data.default_points_position;
            }
        })
        .catch(error => {
            console.error('Error loading recalculation config:', error);
        });
});
</script>
{% endblock %}