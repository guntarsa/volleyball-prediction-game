{% extends "base.html" %}

{% block title %}Admin - Volleyball Predictions{% endblock %}

{% block content %}
<h1 class="page-title">Admin Panel</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload"></i>
                    Import Games from CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_games') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select CSV File:</label>
                        <input type="file" name="file" id="file" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            CSV should have columns: team1, team2, date, time, round, prediction_deadline
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-import"></i> Import Games
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    CSV Format Example
                </h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>team1,team2,date,time,round,prediction_deadline
Brazil,Italy,2024-09-15,14:00,Quarter Final 1,2024-09-15,13:30
USA,Poland,2024-09-15,17:00,Quarter Final 2,2024-09-15,16:30
Serbia,Turkey,2024-09-16,14:00,Quarter Final 3,2024-09-16,13:30</code></pre>
                <small class="text-muted">
                    <i class="fas fa-calendar"></i> Date format: YYYY-MM-DD<br>
                    <i class="fas fa-clock"></i> Time format: HH:MM (24-hour)<br>
                    <i class="fas fa-stopwatch"></i> Prediction deadline: YYYY-MM-DD HH:MM
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i>
                    Tournament Configuration
                </h5>
            </div>
            <div class="card-body">
                {% if tournament_config %}
                    <div class="alert alert-info">
                        <strong>Current Deadline:</strong> {{ tournament_config.prediction_deadline.strftime('%Y-%m-%d %H:%M') }}<br>
                        <strong>Status:</strong> 
                        {% if tournament_config.is_prediction_open() %}
                            <span class="badge bg-success">Open</span>
                        {% else %}
                            <span class="badge bg-danger">Closed</span>
                        {% endif %}
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('set_tournament_config') }}">
                    <div class="mb-3">
                        <label for="prediction_deadline" class="form-label">Tournament Prediction Deadline:</label>
                        <input type="datetime-local" name="prediction_deadline" id="prediction_deadline" 
                               class="form-control" required
                               value="{% if tournament_config %}{{ tournament_config.prediction_deadline.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                        <div class="form-text">Users can predict until this date/time</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-clock"></i> Set Deadline
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-medal"></i>
                    Tournament Results
                </h5>
            </div>
            <div class="card-body">
                {% if tournament_config and tournament_config.are_results_available() %}
                    <div class="alert alert-success">
                        <strong>Results Finalized:</strong><br>
                        1st: {{ tournament_config.first_place_result }}<br>
                        2nd: {{ tournament_config.second_place_result }}<br>
                        3rd: {{ tournament_config.third_place_result }}
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('set_tournament_results') }}">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="first_place_result" class="form-label">1st Place (Winner):</label>
                            <select name="first_place_result" class="form-select" required>
                                <option value="">Select winner...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.first_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="second_place_result" class="form-label">2nd Place (Runner-up):</label>
                            <select name="second_place_result" class="form-select" required>
                                <option value="">Select runner-up...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.second_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="third_place_result" class="form-label">3rd Place (Bronze):</label>
                            <select name="third_place_result" class="form-select" required>
                                <option value="">Select bronze medalist...</option>
                                {% for team in teams %}
                                <option value="{{ team }}"
                                        {% if tournament_config and tournament_config.third_place_result == team %}selected{% endif %}>
                                    {{ team }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-trophy"></i> Finalize Results
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt"></i>
                    Tournament Teams
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_tournament_teams') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="teams_file" class="form-label">Upload Teams CSV:</label>
                        <input type="file" name="file" id="teams_file" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            CSV should have column: team_name, name, or team
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Import Teams
                    </button>
                </form>
                
                {% if tournament_teams %}
                <div class="mt-4">
                    <h6><i class="fas fa-list"></i> Current Teams ({{ tournament_teams|length }})</h6>
                    <div class="row">
                        {% for team in tournament_teams %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                <span class="fw-bold">
                                    {% if team.get_country_code() %}
                                        <span class="fi fi-{{ team.get_country_code() }} team-flag"></span>
                                    {% endif %}
                                    {{ team.name }}
                                </span>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmTeamDelete({{ team.id }}, '{{ team.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="mt-3 alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No tournament teams uploaded yet. Upload a CSV file with team names.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    Teams CSV Format
                </h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>team_name,country_code
Brazil,br
USA,us
Poland,pl
Italy,it
Serbia,rs
Turkey,tr
Japan,jp
China,cn
Netherlands,nl
Dominican Republic,do
...</code></pre>
                <small class="text-muted">
                    <i class="fas fa-users"></i> Expected: 24 teams for tournament<br>
                    <i class="fas fa-file-csv"></i> Format: team_name required, country_code optional<br>
                    <i class="fas fa-flag"></i> Country codes auto-detected if not provided<br>
                    <i class="fas fa-trophy"></i> Used for tournament predictions
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i>
                    Manage Users
                </h5>
            </div>
            <div class="card-body">
                {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Password Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td><strong>{{ user.name }}</strong></td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.is_admin %}
                                        <span class="badge bg-warning text-dark">Admin</span>
                                    {% else %}
                                        <span class="badge bg-secondary">User</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if user.password_reset_required %}
                                        <span class="badge bg-danger">Reset Required</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not user.is_admin %}
                                        {% if user.password_reset_required %}
                                            <span class="text-muted">
                                                <i class="fas fa-clock"></i> Awaiting password change
                                            </span>
                                        {% else %}
                                            <button class="btn btn-sm btn-warning" onclick="confirmPasswordReset({{ user.id }}, '{{ user.name }}')">
                                                <i class="fas fa-key"></i> Reset Password
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Admin user</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <h4><i class="fas fa-users"></i> No Users Found</h4>
                    <p>No users have registered yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-gamepad"></i>
                    Manage Games
                </h5>
            </div>
            <div class="card-body">
                {% if games %}
                <div class="mb-3">
                    <button id="bulkDeleteBtn" class="btn btn-danger" onclick="bulkDeleteGames()" style="display: none;">
                        <i class="fas fa-trash"></i> 
                        <span class="d-none d-sm-inline">Delete Selected Games</span>
                        <span class="d-sm-none">Delete Selected</span>
                    </button>
                    <span id="selectedCount" class="text-muted ms-2"></span>
                </div>
                
                <!-- Hidden form for bulk delete -->
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('bulk_delete_games') }}" style="display: none;">
                </form>
                
                <!-- Desktop Table View -->
                <div class="table-responsive d-none d-lg-block">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleAllGames()">
                                </th>
                                <th>Date & Time</th>
                                <th>Deadline</th>
                                <th>Round</th>
                                <th>Teams</th>
                                <th>Result</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in games %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="game-checkbox" value="{{ game.id }}" onchange="updateBulkDeleteButton()">
                                </td>
                                <td>
                                    <small>{{ game.game_date.strftime('%Y-%m-%d') }}</small><br>
                                    <strong>{{ game.game_date.strftime('%H:%M') }}</strong>
                                </td>
                                <td>
                                    <small>{{ game.prediction_deadline.strftime('%m-%d') }}</small><br>
                                    <strong>{{ game.prediction_deadline.strftime('%H:%M') }}</strong>
                                    {% if game.is_prediction_open() %}
                                        <br><span class="badge bg-success">Open</span>
                                    {% else %}
                                        <br><span class="badge bg-danger">Closed</span>
                                    {% endif %}
                                </td>
                                <td>{{ game.round_name }}</td>
                                <td>
                                    <strong>
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team1 }}
                                    </strong> vs <strong>
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag"></span>
                                        {% endif %}
                                        {{ game.team2 }}
                                    </strong>
                                </td>
                                <td>
                                    {% if game.is_finished %}
                                        <span class="badge bg-success">{{ game.team1_score }} - {{ game.team2_score }}</span>
                                    {% else %}
                                        <span class="text-muted">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if game.is_finished %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Finished
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock"></i> Upcoming
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if not game.is_finished %}
                                        <button class="btn btn-sm btn-primary" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                            <i class="fas fa-edit"></i> Update Result
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}', {{ game.team1_score }}, {{ game.team2_score }})">
                                            <i class="fas fa-edit"></i> Edit Result
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View -->
                <div class="d-lg-none">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="selectAllMobile" onchange="toggleAllGames()">
                                <label class="form-check-label fw-bold" for="selectAllMobile">
                                    Select All Games
                                </label>
                            </div>
                        </div>
                    </div>
                    {% for game in games %}
                    <div class="card mb-3 mobile-game-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input game-checkbox" value="{{ game.id }}" 
                                           onchange="updateBulkDeleteButton()" id="gameCheck{{ game.id }}">
                                    <label class="form-check-label fw-bold" for="gameCheck{{ game.id }}">
                                        {{ game.round_name }}
                                    </label>
                                </div>
                                <div class="text-end">
                                    {% if game.is_finished %}
                                        <span class="badge bg-success mb-1">
                                            <i class="fas fa-check"></i> Finished
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark mb-1">
                                            <i class="fas fa-clock"></i> Upcoming
                                        </span>
                                    {% endif %}
                                    {% if game.is_prediction_open() %}
                                        <span class="badge bg-success d-block">
                                            <i class="fas fa-unlock"></i> Open
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger d-block">
                                            <i class="fas fa-lock"></i> Closed
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Game Date</small>
                                    <div class="fw-bold">{{ game.game_date.strftime('%m/%d') }}</div>
                                    <div>{{ game.game_date.strftime('%H:%M') }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Deadline</small>
                                    <div class="fw-bold">{{ game.prediction_deadline.strftime('%m/%d') }}</div>
                                    <div>{{ game.prediction_deadline.strftime('%H:%M') }}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="team-info">
                                        {% if get_country_code(game.team1) %}
                                            <span class="fi fi-{{ get_country_code(game.team1) }} team-flag me-1"></span>
                                        {% endif %}
                                        <strong>{{ game.team1 }}</strong>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted">VS</small>
                                        {% if game.is_finished %}
                                            <div class="badge bg-success">{{ game.team1_score }} - {{ game.team2_score }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="team-info text-end">
                                        <strong>{{ game.team2 }}</strong>
                                        {% if get_country_code(game.team2) %}
                                            <span class="fi fi-{{ get_country_code(game.team2) }} team-flag ms-1"></span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                {% if not game.is_finished %}
                                <button class="btn btn-primary btn-sm" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                    <i class="fas fa-edit"></i> Update Result
                                </button>
                                {% else %}
                                <button class="btn btn-secondary btn-sm" onclick="showUpdateModal({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}', {{ game.team1_score }}, {{ game.team2_score }})">
                                    <i class="fas fa-edit"></i> Edit Result
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete({{ game.id }}, '{{ game.team1 }}', '{{ game.team2 }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <h4><i class="fas fa-calendar-times"></i> No Games Found</h4>
                    <p>Import games using the CSV upload feature above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Update Result Modal -->
<div class="modal fade" id="updateResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Game Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_result') }}">
                <div class="modal-body">
                    <input type="hidden" name="game_id" id="modalGameId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label" id="team1Label">Team 1 Sets:</label>
                            <input type="number" name="team1_score" id="modalTeam1Score" class="form-control" min="0" max="3" required>
                            <small class="text-muted">Sets won (0-3)</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" id="team2Label">Team 2 Sets:</label>
                            <input type="number" name="team2_score" id="modalTeam2Score" class="form-control" min="0" max="3" required>
                            <small class="text-muted">Sets won (0-3)</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <strong>Volleyball Scoring:</strong> Winner must have 3 sets, loser 0-2 sets (3-0, 3-1, or 3-2).<br>
                            Updating the result will automatically recalculate points for all predictions.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Result</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Game</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="deleteGameForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to delete this game?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="deleteGameInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Note: Games with existing predictions cannot be deleted.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Game
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Reset Confirmation Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="passwordResetForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Password Reset</strong>
                    </div>
                    <p>Are you sure you want to reset the password for this user?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="resetUserInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            The user will be prompted to set a new password on their next login.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team Delete Confirmation Modal -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Tournament Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="deleteTeamForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to delete this tournament team?</p>
                    <div class="bg-light p-3 rounded">
                        <strong id="deleteTeamInfo"></strong>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Note: Teams referenced in tournament predictions cannot be deleted.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Team
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showUpdateModal(gameId, team1, team2, team1Score = '', team2Score = '') {
    document.getElementById('modalGameId').value = gameId;
    document.getElementById('team1Label').textContent = team1 + ' Sets:';
    document.getElementById('team2Label').textContent = team2 + ' Sets:';
    document.getElementById('modalTeam1Score').value = team1Score;
    document.getElementById('modalTeam2Score').value = team2Score;
    
    // Add volleyball validation to modal
    addModalVolleyballValidation();
    
    new bootstrap.Modal(document.getElementById('updateResultModal')).show();
}

function confirmDelete(gameId, team1, team2) {
    document.getElementById('deleteGameForm').action = `/delete_game/${gameId}`;
    document.getElementById('deleteGameInfo').textContent = `${team1} vs ${team2}`;
    
    new bootstrap.Modal(document.getElementById('deleteGameModal')).show();
}

function toggleAllGames() {
    // Handle both desktop and mobile select all checkboxes
    const selectAll = document.getElementById('selectAll');
    const selectAllMobile = document.getElementById('selectAllMobile');
    const checkboxes = document.querySelectorAll('.game-checkbox');
    
    // Determine which select all was clicked
    let isChecked = false;
    if (event && event.target) {
        isChecked = event.target.checked;
        // Sync both select all checkboxes
        if (selectAll) selectAll.checked = isChecked;
        if (selectAllMobile) selectAllMobile.checked = isChecked;
    } else {
        // Fallback: use desktop checkbox state
        isChecked = selectAll ? selectAll.checked : false;
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const checkboxes = document.querySelectorAll('.game-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectedCount = document.getElementById('selectedCount');
    
    if (checkboxes.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
        selectedCount.textContent = `${checkboxes.length} game(s) selected`;
    } else {
        bulkDeleteBtn.style.display = 'none';
        selectedCount.textContent = '';
    }
}

function bulkDeleteGames() {
    const checkboxes = document.querySelectorAll('.game-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one game to delete.');
        return;
    }
    
    const gameCount = checkboxes.length;
    const gameIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (!confirm(`Are you sure you want to delete ${gameCount} selected game(s)? This action cannot be undone.\n\nGame IDs: ${gameIds.join(', ')}`)) {
        return;
    }
    
    // Use the existing form and clear any previous inputs
    const form = document.getElementById('bulkDeleteForm');
    form.innerHTML = ''; // Clear any existing inputs
    
    checkboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'game_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    // Debug: log form data before submission
    console.log('Submitting bulk delete for games:', gameIds);
    console.log('Form action:', form.action);
    console.log('Form method:', form.method);
    
    form.submit();
}

function addModalVolleyballValidation() {
    const team1Input = document.getElementById('modalTeam1Score');
    const team2Input = document.getElementById('modalTeam2Score');
    const modal = document.getElementById('updateResultModal');
    const submitBtn = modal.querySelector('button[type="submit"]');
    
    function validateModalScore() {
        const team1Score = parseInt(team1Input.value) || 0;
        const team2Score = parseInt(team2Input.value) || 0;
        
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (team1Input.value && team2Input.value) {
            if (isValid) {
                team1Input.classList.remove('is-invalid');
                team2Input.classList.remove('is-invalid');
                team1Input.classList.add('is-valid');
                team2Input.classList.add('is-valid');
                submitBtn.disabled = false;
            } else {
                team1Input.classList.remove('is-valid');
                team2Input.classList.remove('is-valid');
                team1Input.classList.add('is-invalid');
                team2Input.classList.add('is-invalid');
                submitBtn.disabled = true;
            }
        } else {
            team1Input.classList.remove('is-valid', 'is-invalid');
            team2Input.classList.remove('is-valid', 'is-invalid');
            submitBtn.disabled = false;
        }
    }
    
    team1Input.addEventListener('input', validateModalScore);
    team2Input.addEventListener('input', validateModalScore);
    
    // Prevent form submission with invalid scores
    modal.querySelector('form').addEventListener('submit', function(e) {
        const team1Score = parseInt(team1Input.value) || 0;
        const team2Score = parseInt(team2Input.value) || 0;
        
        const isValid = (team1Score === 3 && team2Score >= 0 && team2Score <= 2) ||
                       (team2Score === 3 && team1Score >= 0 && team1Score <= 2);
        
        if (!isValid) {
            e.preventDefault();
            alert('Invalid volleyball score! Winner must have 3 sets, loser 0-2 sets.');
        }
    });
}

function confirmPasswordReset(userId, userName) {
    document.getElementById('passwordResetForm').action = `/admin/reset-user-password/${userId}`;
    document.getElementById('resetUserInfo').textContent = userName;
    
    new bootstrap.Modal(document.getElementById('passwordResetModal')).show();
}

function confirmTeamDelete(teamId, teamName) {
    document.getElementById('deleteTeamForm').action = `/delete_tournament_team/${teamId}`;
    document.getElementById('deleteTeamInfo').textContent = teamName;
    
    new bootstrap.Modal(document.getElementById('deleteTeamModal')).show();
}
</script>
{% endblock %}