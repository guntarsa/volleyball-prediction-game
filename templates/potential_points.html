{% extends "base.html" %}

{% block title %}What-If Analysis - Men's World Championship 2025{% endblock %}

{% block content %}
<h1 class="page-title">What-If Analysis</h1>

{% if message %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i>
                            What-If Analysis Status
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle text-warning fa-3x"></i>
                        </div>
                        <h4 class="text-primary mb-3">{{ message }}</h4>
                        <p class="lead text-muted mb-4">{{ suggestion }}</p>

                        {% if stats %}
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-4">
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <h3 class="text-primary mb-1">{{ stats.total_games }}</h3>
                                                <small class="text-muted">Total Games</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <h3 class="text-success mb-1">{{ stats.finished_games }}</h3>
                                                <small class="text-muted">Completed</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <h3 class="text-warning mb-1">{{ stats.upcoming_games }}</h3>
                                                <small class="text-muted">Open for Predictions</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mt-4">
                            {% if stats and stats.upcoming_games > 0 %}
                                <a href="{{ url_for('predictions') }}" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-gamepad"></i> Make Predictions
                                </a>
                            {% endif %}
                            <a href="{{ url_for('leaderboard') }}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-medal"></i> View Leaderboard
                            </a>
                        </div>

                        <div class="mt-4">
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb"></i>
                                <strong>About What-If Analysis:</strong> This feature shows how different game outcomes could affect player rankings when prediction deadlines have passed but results aren't known yet. It helps you understand the potential impact of upcoming games on your position.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="container-fluid">
        <!-- Game Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-volleyball-ball"></i>
                            Next Unfinished Game
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 class="mb-2">
                                    {% if get_country_code(target_game.team1) %}
                                        <span class="fi fi-{{ get_country_code(target_game.team1) }} team-flag"></span>
                                    {% endif %}
                                    {{ target_game.team1 }}
                                    <span class="text-muted">vs</span>
                                    {{ target_game.team2 }}
                                    {% if get_country_code(target_game.team2) %}
                                        <span class="fi fi-{{ get_country_code(target_game.team2) }} team-flag"></span>
                                    {% endif %}
                                </h4>
                                <p class="mb-0">
                                    <i class="fas fa-calendar-alt"></i> {{ target_game.game_date.strftime('%Y-%m-%d %H:%M') }} |
                                    <strong>{{ target_game.round_name }}</strong>
                                </p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <span class="badge bg-warning text-dark fs-6">
                                    <i class="fas fa-clock"></i> Deadline Passed
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Color Legend -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-palette"></i>
                            Points Legend
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <span class="badge bg-success text-white fs-6">6 pts</span> Perfect prediction
                                    <span class="badge bg-primary text-white fs-6">4 pts</span> Correct winner + missed by 1 set
                                    <span class="badge bg-info text-white fs-6">2 pts</span> Correct winner only
                                    <span class="badge bg-warning text-dark fs-6">1 pt</span> Wrong winner but correct total sets
                                    <span class="badge bg-danger text-white fs-6">0 pts</span> Completely wrong / No prediction
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Potential Points Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i>
                            Potential Total Points After Game
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Desktop Table View -->
                        <div class="table-responsive d-none d-lg-block">
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th rowspan="2" class="align-middle">Player</th>
                                        <th rowspan="2" class="align-middle text-center">Current<br>Pos/Total</th>
                                        <th colspan="3" class="text-center border-end">{{ target_game.team1 }} Wins</th>
                                        <th colspan="3" class="text-center">{{ target_game.team2 }} Wins</th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">3-0</th>
                                        <th class="text-center">3-1</th>
                                        <th class="text-center border-end">3-2</th>
                                        <th class="text-center">3-2</th>
                                        <th class="text-center">3-1</th>
                                        <th class="text-center">3-0</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set users_list = scenarios[0]['user_results'] if scenarios else [] %}
                                    {% for user_result in users_list %}
                                    <tr>
                                        <td><strong>{{ user_result['user']['name'] }}</strong></td>
                                        <td class="text-center">
                                            <strong>#{{ user_result['current_position'] }}</strong>
                                            <br><small>{{ user_result['user']['total_score'] }} pts</small>
                                        </td>
                                        {% for scenario in scenarios %}
                                            {% set user_data = scenario['user_results'] | selectattr('user.id', 'equalto', user_result['user']['id']) | first %}
                                            <td class="text-center {{ get_point_color_class(user_data['points_earned']) }} {% if loop.index == 3 %}border-end{% endif %}">
                                                {% if user_data['position_change'] > 0 %}
                                                    <span class="badge bg-success mb-1"><i class="fas fa-arrow-up"></i> +{{ user_data['position_change'] }}</span>
                                                {% elif user_data['position_change'] < 0 %}
                                                    <span class="badge bg-danger mb-1"><i class="fas fa-arrow-down"></i> {{ user_data['position_change'] }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary mb-1"><i class="fas fa-equals"></i></span>
                                                {% endif %}
                                                <br>
                                                <strong>#{{ user_data['new_position'] }}</strong> | <strong>{{ user_data['total_after_game'] }}</strong>
                                                <br><small>(+{{ user_data['points_earned'] }} pts)</small>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Mobile-Friendly View -->
                        <div class="d-lg-none">
                            <!-- Player selector for mobile -->
                            <div class="mb-3">
                                <label for="mobile-player-select" class="form-label">
                                    <i class="fas fa-user"></i> Select Player to Analyze:
                                </label>
                                <select id="mobile-player-select" class="form-select" onchange="updateMobileView()">
                                    {% set users_list = scenarios[0]['user_results'] if scenarios else [] %}
                                    {% set current_user_found = false %}
                                    {% for user_result in users_list %}
                                    <option value="{{ user_result['user']['id'] }}" {% if user_result['user']['id'] == current_user.id %}selected{% set current_user_found = true %}{% endif %}>
                                        {{ user_result['user']['name'] }}{% if user_result['user']['id'] == current_user.id %} (You){% endif %}
                                    </option>
                                    {% endfor %}
                                    <option value="all" {% if not current_user_found %}selected{% endif %}>Show All Players (Summary)</option>
                                </select>
                            </div>

                            <!-- All players summary view -->
                            <div id="mobile-all-view" {% if current_user_found %}style="display: none;"{% endif %}>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert alert-info p-2">
                                            <small><i class="fas fa-chart-line"></i> <strong>Position Changes Overview:</strong> See how the leaderboard could change with each game outcome. Select a player above for detailed analysis.</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Major Position Changes by Scenario -->
                                {% for scenario in scenarios %}
                                <div class="card mb-3">
                                    <div class="card-header p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-volleyball-ball"></i> {{ scenario['label'] }}</h6>
                                            <small class="text-muted">{{ scenario['notable_changes']|length }} position changes</small>
                                        </div>
                                    </div>
                                    {% if scenario['notable_changes'] %}
                                    <div class="card-body p-2">
                                        {% for change in scenario['notable_changes'][:4] %}
                                        <div class="d-flex justify-content-between align-items-center py-1 {% if not loop.last %}border-bottom{% endif %}">
                                            <div class="d-flex align-items-center">
                                                <span class="fw-bold {% if change['user']['id'] == current_user.id %}text-primary{% endif %}">
                                                    {{ change['user']['name'] }}{% if change['user']['id'] == current_user.id %} (You){% endif %}
                                                </span>
                                                {% if change['position_change'] > 0 %}
                                                    <span class="badge bg-success ms-2">
                                                        <i class="fas fa-arrow-up"></i> +{{ change['position_change'] }}
                                                    </span>
                                                {% elif change['position_change'] < 0 %}
                                                    <span class="badge bg-danger ms-2">
                                                        <i class="fas fa-arrow-down"></i> {{ change['position_change'] }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">#{{ change['current_position'] }} → #{{ change['new_position'] }}</small>
                                                <br>
                                                <small class="{{ 'text-success' if change['points_earned'] >= 4 else 'text-danger' if change['points_earned'] == 0 else 'text-warning' }}">+{{ change['points_earned'] }} pts</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% if scenario['notable_changes']|length > 4 %}
                                        <small class="text-muted mt-1">... and {{ scenario['notable_changes']|length - 4 }} more position changes</small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="card-body p-2 text-center text-muted">
                                        <small><i class="fas fa-equals"></i> No position changes in this scenario</small>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}

                            </div>

                            <!-- Individual player detailed view -->
                            <div id="mobile-player-view" {% if not current_user_found %}style="display: none;"{% endif %}>
                                <div class="card">
                                    <div class="card-header p-2">
                                        <h6 class="mb-1" id="selected-player-name">Player Details</h6>
                                        <small class="text-muted">Current total: <span id="selected-player-current">0</span> points</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-2" id="player-scenarios">
                                            <!-- Will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>How to read this analysis:</strong>
                                <ul class="mb-2">
                                    <li><strong>Position changes:</strong> <span class="badge bg-success"><i class="fas fa-arrow-up"></i> +2</span> means moving up 2 positions, <span class="badge bg-danger"><i class="fas fa-arrow-down"></i> -1</span> means dropping 1 position</li>
                                    <li><strong>Points colors:</strong> Green (6), Blue (4), Light Blue (2), Yellow (1), Red (0)</li>
                                    <li><strong>Desktop table:</strong> Shows new position | total points (points from this game)</li>
                                    <li><strong>Mobile view:</strong> Select yourself or any player to see detailed position changes for each scenario</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Mobile view management
const scenarioData = {{ scenarios | tojson | safe }};
const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize mobile view
    updateMobileView();

    // If current user is selected by default, display their details immediately
    const selector = document.getElementById('mobile-player-select');
    if (selector && selector.value !== 'all' && currentUserId) {
        const selectedUserId = parseInt(selector.value);
        if (selectedUserId === currentUserId) {
            displayPlayerDetails(selectedUserId);
        }
    }
});

function updateMobileView() {
    const selector = document.getElementById('mobile-player-select');
    const allView = document.getElementById('mobile-all-view');
    const playerView = document.getElementById('mobile-player-view');

    if (!selector || !allView || !playerView) return;

    const selectedValue = selector.value;

    if (selectedValue === 'all') {
        allView.style.display = 'block';
        playerView.style.display = 'none';
    } else {
        allView.style.display = 'none';
        playerView.style.display = 'block';
        displayPlayerDetails(parseInt(selectedValue));
    }
}

function displayPlayerDetails(userId) {
    const playerNameEl = document.getElementById('selected-player-name');
    const playerCurrentEl = document.getElementById('selected-player-current');
    const scenariosEl = document.getElementById('player-scenarios');

    if (!scenarioData || scenarioData.length === 0) return;

    // Find player data
    const firstScenario = scenarioData[0];
    const playerData = firstScenario.user_results.find(user => user.user.id === userId);

    if (!playerData) return;

    // Update player info
    playerNameEl.textContent = playerData.user.name + (userId === currentUserId ? ' (You)' : '');
    playerCurrentEl.textContent = playerData.user.total_score || '0';

    // Clear and populate scenarios
    scenariosEl.innerHTML = '';

    scenarioData.forEach(scenario => {
        const userResult = scenario.user_results.find(user => user.user.id === userId);
        if (!userResult) return;

        const pointsClass = getPointColorClass(userResult.points_earned);
        const isGoodOutcome = userResult.points_earned >= 4;

        // Position change indicators
        let positionIndicator = '';
        if (userResult.position_change > 0) {
            positionIndicator = `<span class="badge bg-success"><i class="fas fa-arrow-up"></i> +${userResult.position_change}</span>`;
        } else if (userResult.position_change < 0) {
            positionIndicator = `<span class="badge bg-danger"><i class="fas fa-arrow-down"></i> ${userResult.position_change}</span>`;
        } else {
            positionIndicator = `<span class="badge bg-secondary"><i class="fas fa-equals"></i> 0</span>`;
        }

        // Determine text color for small elements based on background
        const isYellowBackground = userResult.points_earned === 1;
        const smallTextClass = isYellowBackground ? 'text-muted' : 'text-light';

        scenariosEl.innerHTML += `
            <div class="col-6 mb-2">
                <div class="card ${pointsClass}" style="border: 2px solid ${isGoodOutcome ? '#28a745' : '#dc3545'};">
                    <div class="card-body p-2 text-center">
                        <div class="fw-bold small">${scenario.label}</div>
                        <div class="h5 mb-1">${userResult.total_after_game} <small class="${smallTextClass}">pts</small></div>
                        <div class="mb-1">${positionIndicator}</div>
                        <small class="${smallTextClass}">#${userResult.current_position} → #${userResult.new_position}</small>
                        <br>
                        <small class="${smallTextClass}">(+${userResult.points_earned} from game)</small>
                    </div>
                </div>
            </div>
        `;
    });
}

function getPointColorClass(points) {
    if (points === 6) return 'bg-success text-light';
    if (points === 4) return 'bg-primary text-light';
    if (points === 2) return 'bg-info text-light';
    if (points === 1) return 'bg-warning text-dark';  // Keep dark text for yellow background
    return 'bg-danger text-light';
}

// Auto-select current user on mobile if available
document.addEventListener('DOMContentLoaded', function() {
    const selector = document.getElementById('mobile-player-select');
    if (selector && currentUserId) {
        // Current user is already selected by default in the template
        updateMobileView();
    }
});
</script>
{% endblock %}