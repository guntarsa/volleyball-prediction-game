{% extends "base.html" %}

{% block title %}Race Chart - Men's World Championship 2025{% endblock %}

{% block head %}
<style>
    .chart-container {
        position: relative;
        height: 500px;
        margin: 20px 0;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    #race-chart {
        width: 100% !important;
        height: 460px !important;
        display: block !important;
    }

    .filters-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group label {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 5px;
        display: block;
    }

    .player-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 8px;
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        background: #f8f9fa;
        font-size: 14px;
    }

    .selected-players-display {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        font-size: 14px;
        color: #495057;
        max-height: 60px;
        overflow-y: auto;
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .filter-toggle {
        color: #667eea !important;
        text-decoration: none !important;
        font-size: 14px;
        padding: 4px 8px !important;
    }

    .filter-toggle:hover {
        color: #5a6fd8 !important;
        background-color: rgba(102, 126, 234, 0.1) !important;
    }

    .player-checkboxes-container {
        margin-top: 10px;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }
        to {
            opacity: 1;
            max-height: 200px;
        }
    }

    .filter-group {
        margin-bottom: 20px;
    }

    .player-checkbox {
        display: flex;
        align-items: center;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .player-checkbox:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }

    .player-checkbox input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.1);
    }

    .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        flex-wrap: wrap;
        gap: 10px;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-export {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
    }

    .error {
        text-align: center;
        padding: 40px;
        color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
        border-radius: 8px;
        margin: 20px 0;
    }

    @media (max-width: 768px) {
        .chart-container {
            height: 400px;
            padding: 15px;
            margin: 15px 0;
        }

        .player-checkboxes {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            max-height: 120px;
        }

        .chart-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .export-buttons {
            justify-content: center;
        }

        .filters-section {
            padding: 15px;
            margin: 15px 0;
        }

        .filter-group label {
            font-size: 14px;
        }

        .btn-export {
            padding: 12px 20px;
            font-size: 16px;
            min-height: 44px;
        }

        .form-control {
            font-size: 16px !important;
            min-height: 44px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .btn {
            min-height: 44px;
            font-size: 16px;
        }
    }

    @media (max-width: 480px) {
        .chart-container {
            height: 350px;
            margin: 15px 0;
        }

        .player-checkboxes {
            grid-template-columns: 1fr 1fr;
            max-height: 100px;
        }

        .export-buttons {
            flex-direction: column;
            gap: 8px;
        }

        .btn-export {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-4">
                <h1 class="text-white">
                    <i class="fas fa-chart-line me-2"></i>
                    Cumulative Points Race Chart
                </h1>
                <p class="text-white-50">
                    Track how each player's points accumulate throughout the tournament
                </p>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <h4 class="mb-3">
                    <i class="fas fa-filter me-2"></i>
                    Filters
                </h4>

                <form id="filter-form">
                    <!-- Game Display Control -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="filter-group">
                                <label for="game-interval" class="mb-2">Chart Density:</label>
                                <select id="game-interval" class="form-control" onchange="updateChart()">
                                    <option value="1">Show every game</option>
                                    <option value="2">Show every 2nd game</option>
                                    <option value="3">Show every 3rd game</option>
                                    <option value="5" selected>Show every 5th game</option>
                                    <option value="10">Show every 10th game</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="filter-group">
                                <label class="mb-2">Quick Actions:</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllPlayers()">
                                        All Players
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="selectTopPlayers()">
                                        Top 5
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNonePlayers()">
                                        Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Player Selection -->
                    <div class="filter-group">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">Players:</label>
                            <button type="button" class="btn btn-sm btn-link filter-toggle" onclick="togglePlayerFilter()" id="player-filter-toggle">
                                <i class="fas fa-chevron-down me-1"></i>Show player list
                            </button>
                        </div>

                        <!-- Compact view (default) -->
                        <div class="selected-players-display" id="selected-players-display">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <!-- Expanded view (hidden by default) -->
                        <div class="player-checkboxes-container" id="player-checkboxes-container" style="display: none;">
                            <div class="player-checkboxes" id="player-checkboxes">
                                {% for user in users %}
                                <div class="player-checkbox">
                                    <input type="checkbox" id="player_{{ user.id }}" name="users[]" value="{{ user.id }}" checked onchange="updateSelectedPlayersDisplay()">
                                    <label for="player_{{ user.id }}">{{ user.name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-primary" onclick="updateChart()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Update Chart
                        </button>
                    </div>
                </form>
            </div>

            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="chart-info">
                    <small class="text-white-50">
                        <i class="fas fa-info-circle me-1"></i>
                        Showing position changes through finished games. Hover lines to see cumulative points.
                    </small>
                </div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportChartData()">
                        <i class="fas fa-download me-2"></i>
                        Export Data (CSV)
                    </button>
                    <button class="btn-export" onclick="exportChartImage()">
                        <i class="fas fa-image me-2"></i>
                        Export Chart (PNG)
                    </button>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="chart-container">
                <div id="loading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading chart data...</p>
                </div>
                <div id="error" class="error" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load chart data. Please try again.</p>
                </div>
                <canvas id="race-chart" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Load Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
let chart = null;
let chartData = null;
let tooltipTimeout = null;

// Function to check if Chart.js is loaded and initialize
function initializeWhenReady() {
    if (typeof Chart === 'undefined') {
        console.log('Waiting for Chart.js to load...');
        setTimeout(initializeWhenReady, 100);
        return;
    }

    console.log('Chart.js loaded successfully, version:', Chart.version);
    updateChart();
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeWhenReady();
    updateSelectedPlayersDisplay();
});

async function updateChart() {
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const chartCanvas = document.getElementById('race-chart');

    // Show loading state
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    chartCanvas.style.display = 'none';

    try {
        // Get filter parameters
        const formData = new FormData(document.getElementById('filter-form'));
        const params = new URLSearchParams();

        // Add selected users
        const selectedUsers = formData.getAll('users[]');
        console.log('Selected users:', selectedUsers);
        selectedUsers.forEach(userId => params.append('users[]', userId));

        // No date filtering needed anymore

        const url = `/api/race-chart-data?${params.toString()}`;
        console.log('Fetching URL:', url);

        const response = await fetch(url);
        console.log('Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('API response:', result);

        if (result.success) {
            chartData = result.data;

            // Check if there's any data to display
            if (!chartData.games || chartData.games.length === 0) {
                // Show a helpful message instead of error
                errorDiv.style.background = 'rgba(102, 126, 234, 0.1)';
                errorDiv.style.color = '#667eea';
                errorDiv.innerHTML = `
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>No Finished Games Yet</h5>
                    <p>The race chart will show player progress once games are completed.</p>
                    <div class="mt-3">
                        <strong>For Admins:</strong>
                        <ol class="text-start mt-2">
                            <li>Add games through the Admin panel</li>
                            <li>Enter game results when matches finish</li>
                            <li>Mark games as "finished"</li>
                        </ol>
                    </div>
                    <p class="mt-3">
                        <a href="/admin" class="btn btn-primary btn-sm">
                            <i class="fas fa-cog me-2"></i>Go to Admin Panel
                        </a>
                    </p>
                `;
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                return;
            }

            // Hide loading, show chart FIRST
            loadingDiv.style.display = 'none';
            chartCanvas.style.display = 'block';

            // Small delay to ensure canvas is rendered before creating chart
            setTimeout(() => {
                renderChart(chartData);
                console.log('Chart canvas should now be visible');
            }, 100);
        } else {
            throw new Error(result.error || 'Failed to load data');
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
    }
}

function renderChart(data) {
    console.log('renderChart called with data:', data);

    const chartCanvas = document.getElementById('race-chart');
    console.log('Chart canvas element:', chartCanvas);

    if (!chartCanvas) {
        console.error('Chart canvas element not found!');
        return;
    }

    const ctx = chartCanvas.getContext('2d');
    console.log('Chart context:', ctx);

    // Destroy existing chart
    if (chart) {
        console.log('Destroying existing chart');
        chart.destroy();
    }

    // Prepare datasets with mobile-responsive settings
    const isMobile = window.innerWidth < 768;
    const datasets = data.players.map(player => ({
        label: player.name,
        data: player.data,
        borderColor: player.color,
        backgroundColor: player.color + '20',
        borderWidth: isMobile ? 2 : 3,
        fill: false,
        tension: 0.2,
        pointRadius: 0, // Remove circles
        pointHoverRadius: 6, // Show circle only on hover
        pointBackgroundColor: player.color,
        pointBorderColor: '#fff',
        pointBorderWidth: 2
    }));

    // Apply game interval filtering
    const gameInterval = parseInt(document.getElementById('game-interval').value) || 1;
    const filteredData = applyGameIntervalFilter(data, gameInterval);

    console.log('Creating chart with datasets:', datasets);
    console.log('Game labels:', filteredData.labels);

    // Create chart
    try {
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: filteredData.labels,
                datasets: filteredData.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2,
                layout: {
                    padding: 10
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                onHover: function(event, activeElements) {
                    // Clear any existing timeout
                    if (tooltipTimeout) {
                        clearTimeout(tooltipTimeout);
                    }

                    // If hovering over elements, show tooltip and set auto-hide
                    if (activeElements.length > 0) {
                        // Auto-hide tooltip after 4 seconds of no mouse movement
                        tooltipTimeout = setTimeout(() => {
                            if (chart && chart.tooltip) {
                                chart.tooltip.setActiveElements([], {x: 0, y: 0});
                                chart.update('none');
                            }
                        }, 4000);
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Position Race Chart',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        color: '#ffffff' // White title text
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 12
                            },
                            color: '#ffffff' // White text for legend
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        cornerRadius: 6,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                const gameIndex = context[0].dataIndex;
                                const game = data.games[gameIndex];
                                return game.date;
                            },
                            label: function(context) {
                                const gameIndex = context.dataIndex;
                                const datasetData = context.dataset;

                                // Try to get points from the dataset or the original player data
                                let points = 0;
                                if (datasetData.points_data && datasetData.points_data[gameIndex] !== undefined) {
                                    points = datasetData.points_data[gameIndex];
                                } else {
                                    // Fallback: find in original data
                                    const player = data.players.find(p => p.name === context.dataset.label);
                                    if (player && player.points_data && player.points_data[gameIndex] !== undefined) {
                                        points = player.points_data[gameIndex];
                                    }
                                }

                                return `${context.dataset.label}: ${points}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Games (Chronological Order)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#ffffff' // White axis title
                        },
                        ticks: {
                            color: '#ffffff' // White axis labels
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)' // Light grid lines
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Position',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#ffffff' // White axis title
                        },
                        reverse: true, // Invert Y-axis so position 1 is at top
                        beginAtZero: false,
                        min: 1,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)' // Light grid lines
                        },
                        ticks: {
                            stepSize: 1,
                            color: '#ffffff', // White axis labels
                            callback: function(value) {
                                return '#' + value; // Add # prefix to position numbers
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });

        console.log('Chart created successfully:', chart);

        // Force canvas to have proper dimensions and trigger resize
        setTimeout(() => {
            const canvas = document.getElementById('race-chart');
            canvas.style.height = '460px';
            canvas.style.width = '100%';

            if (chart) {
                chart.resize();
                chart.update('none'); // Update without animation
                console.log('Chart resized, new dimensions:', chart.width, 'x', chart.height);
                console.log('Chart area:', chart.chartArea);
            }

            // Add mobile touch handling for tooltip auto-hide
            canvas.addEventListener('touchstart', function(e) {
                // Clear any existing timeout
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                }

                // On mobile, hide tooltip after 4 seconds of no interaction
                tooltipTimeout = setTimeout(() => {
                    if (chart && chart.tooltip) {
                        chart.tooltip.setActiveElements([], {x: 0, y: 0});
                        chart.update('none');
                    }
                }, 4000);
            });

            // Hide tooltip when touching elsewhere on the chart
            canvas.addEventListener('touchend', function(e) {
                // Short delay to allow tooltip to show first, then auto-hide
                setTimeout(() => {
                    if (tooltipTimeout) {
                        clearTimeout(tooltipTimeout);
                    }
                    tooltipTimeout = setTimeout(() => {
                        if (chart && chart.tooltip) {
                            chart.tooltip.setActiveElements([], {x: 0, y: 0});
                            chart.update('none');
                        }
                    }, 4000);
                }, 100);
            });
        }, 200);

    } catch (error) {
        console.error('Error creating chart:', error);
        throw error;
    }
}

// Player selection functions
function selectAllPlayers() {
    const checkboxes = document.querySelectorAll('#player-checkboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedPlayersDisplay();
}

function selectNonePlayers() {
    const checkboxes = document.querySelectorAll('#player-checkboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedPlayersDisplay();
}

function selectTopPlayers() {
    selectNonePlayers();

    // If we have chart data, use it to select top players
    if (chartData && chartData.players) {
        const sortedPlayers = chartData.players
            .slice()
            .sort((a, b) => b.total_score - a.total_score)
            .slice(0, 5);

        sortedPlayers.forEach(player => {
            const checkbox = document.getElementById(`player_${player.id}`);
            if (checkbox) checkbox.checked = true;
        });
    } else {
        // Fallback: select first 5 checkboxes
        const checkboxes = document.querySelectorAll('#player-checkboxes input[type="checkbox"]');
        for (let i = 0; i < Math.min(5, checkboxes.length); i++) {
            checkboxes[i].checked = true;
        }
    }
    updateSelectedPlayersDisplay();
}

function resetFilters() {
    document.getElementById('game-interval').value = '5';
    selectAllPlayers();
    updateChart();
}

// New filter functions
function togglePlayerFilter() {
    const container = document.getElementById('player-checkboxes-container');
    const toggle = document.getElementById('player-filter-toggle');
    const icon = toggle.querySelector('i');

    if (container.style.display === 'none') {
        // Show the list
        container.style.display = 'block';
        toggle.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Hide player list';
    } else {
        // Hide the list
        container.style.display = 'none';
        toggle.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Show player list';
    }
}

function updateSelectedPlayersDisplay() {
    const checkboxes = document.querySelectorAll('#player-checkboxes input[type="checkbox"]:checked');
    const display = document.getElementById('selected-players-display');

    if (checkboxes.length === 0) {
        display.innerHTML = '<em>No players selected</em>';
    } else if (checkboxes.length <= 8) {
        const names = Array.from(checkboxes).map(cb => cb.nextElementSibling.textContent).join(', ');
        display.innerHTML = names;
    } else {
        display.innerHTML = `${checkboxes.length} players selected`;
    }
}

function applyGameIntervalFilter(data, interval) {
    if (interval <= 1) {
        // Return all data
        return {
            labels: data.games.map((game, index) => `Game ${index + 1}`),
            datasets: data.players.map(player => ({
                label: player.name,
                data: player.data, // Position data
                points_data: player.points_data, // Points data for tooltips
                borderColor: player.color,
                backgroundColor: player.color + '20',
                borderWidth: window.innerWidth < 768 ? 2 : 3,
                fill: false,
                tension: 0.2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: player.color,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }))
        };
    }

    // Filter games by interval, ensuring the last game is always included
    const totalGames = data.games.length;
    const lastIndex = totalGames - 1;

    // Create array of indices to include, starting from the last game and working backward
    const indicesToInclude = [];

    // Always include the last game (if there are any games)
    if (totalGames > 0) {
        indicesToInclude.push(lastIndex);

        // Add every nth game before the last one
        for (let i = lastIndex - interval; i >= 0; i -= interval) {
            indicesToInclude.unshift(i); // Add to beginning to maintain chronological order
        }
    }

    const filteredGames = indicesToInclude.map(index => data.games[index]);
    const filteredIndices = indicesToInclude;

    return {
        labels: filteredGames.map((game, index) => `Game ${filteredIndices[index] + 1}`),
        datasets: data.players.map(player => ({
            label: player.name,
            data: filteredIndices.map(index => player.data[index]), // Position data
            points_data: filteredIndices.map(index => player.points_data ? player.points_data[index] : 0), // Points data for tooltips
            borderColor: player.color,
            backgroundColor: player.color + '20',
            borderWidth: window.innerWidth < 768 ? 2 : 3,
            fill: false,
            tension: 0.2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointBackgroundColor: player.color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }))
    };
}

// Export functions
async function exportChartData() {
    if (!chartData) {
        alert('No chart data available to export');
        return;
    }

    // Create detailed CSV content
    let csvContent = 'Player,Final Position,Total Score,Tournament Points,';
    csvContent += chartData.games.map((game, i) => `Game ${i + 1} (${game.label})`).join(',');
    csvContent += '\n';

    chartData.players.forEach(player => {
        csvContent += `${player.name},${player.final_position},${player.total_score},${player.tournament_points},${player.data.join(',')}\n`;
    });

    // Add summary section
    csvContent += '\n\nGAME DETAILS\n';
    csvContent += 'Game Number,Teams,Date,Round\n';
    chartData.games.forEach((game, i) => {
        csvContent += `${i + 1},"${game.label}",${game.date},${game.round}\n`;
    });

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `volleyball_race_chart_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function exportChartImage() {
    if (!chart) {
        alert('No chart available to export');
        return;
    }

    // Get chart as image
    const url = chart.toBase64Image();
    const a = document.createElement('a');
    a.href = url;
    a.download = 'volleyball_race_chart.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}